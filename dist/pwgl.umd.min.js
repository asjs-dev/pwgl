!function(t){"function"==typeof define&&define.amd?define(t):t()}(function(){"use strict";const t={a:"Attrib",u:"Uniform"},e=(t,e,s)=>{const i=t.createShader(s);return t.shaderSource(i,e),t.compileShader(i),i},s=Math.PI/180,i={ALPHA:90*s,THETA:s,GLSL:{VERSION:"#version 300 es\n",DEFINE:{RADIANS_360:"#define RADIANS_360 radians(360.)\n",HEIGHT:"#define HEIGHT 255.\n",Z:"#define Z vec3(0,1,-1)\n",PI:`#define PI ${Math.PI}\n`},RANDOM:"float rand(vec2 p,float s){p=mod(p,vec2(1e4));return fract(sin((p.x*12.9898+p.y*78.233)*s)*43758.5453);}float rand(vec2 p){return rand(p,1.);}",RANDOM2:"float rand2(vec2 p,float s){p=mod(p*100.,vec2(1e4))+100.;return fract(dot(p,vec2(sin(p.x+p.y),cos(p.y-p.x))*s));}float rand2(vec2 p){return rand2(p,1.);}"},INFO:{isWebGl2Supported:!1},initContextConfig:(t={})=>({canvas:document.createElement("canvas"),...t,contextAttributes:{powerPreference:"high-performance",preserveDrawingBuffer:!1,premultipliedAlpha:!1,...t.contextAttributes||{}}}),initRendererConfig:(t={})=>({...t,locations:t.locations??[],context:(t.config&&t.config.context)??t.context??new l}),setLocations:(t,e)=>t.locations=[...t.locations,...e],initApplication:t=>{const e=()=>t(i.INFO.isWebGl2Supported);["interactive","complete"].includes(document.readyState)?e():document.addEventListener("DOMContentLoaded",e,{once:!0})},createProgram:(t,s,i)=>{const r=e(t,s,35633),a=e(t,i,35632),h=t.createProgram();if(t.attachShader(h,r),t.attachShader(h,a),t.linkProgram(h),!t.getProgramParameter(h,35714)){const e=t.getShaderInfoLog(r),n=t.getShaderInfoLog(a);throw console.error(["Program info: "+t.getProgramInfoLog(h),"Validate status: "+t.getProgramParameter(h,35715),...e?["","Vertex shader info: "+e,"Vertex shader: "+s]:"",...n?["","Fragment shader info: "+n,"Fragment shader: "+i]:""].join("\n")),t.deleteShader(r),t.deleteShader(a),t.deleteProgram(h),"WebGL application stoped"}return h},getLocationsFor:(e,s,i)=>{const r={};return i.forEach(i=>r[i]=e[`get${t[i[0]]}Location`](s,i)),r}},r={},a=document.createElement("canvas").getContext("webgl2");if(a){for(let t in a){const e=a[t];"number"==typeof e&&t===t.toUpperCase()&&(r[t]=e)}i.INFO.isWebGl2Supported=!0,i.INFO.maxTextureImageUnits=a.getParameter(34930)}const h=(t,e)=>({functionName:"blendFunc"+(t.length<3?"":"Separate"),functions:t,equationName:"blendEquation"+(!e||e.length<2?"":"Separate"),equations:e||[32774]}),n={createBlendMode:h,NONE:h([0,0]),NORMAL_PM:h([1,771]),ADD_PM:h([1,1]),MULTIPLY_PM:h([774,771,1,771]),SCREEN_PM:h([1,769,1,771]),ADD_NPM:h([770,1,1,1]),SRC_IN:h([772,0]),SRC_OUT:h([773,0]),SRC_ATOP:h([772,771]),DST_OVER:h([773,1]),DST_IN:h([0,770]),DST_OUT:h([0,771]),DST_ATOP:h([773,770]),XOR:h([773,771]),NORMAL:h([770,771,1,771]),ADD:h([770,772,1,772]),MULTIPLY:h([774,0]),SCREEN:h([770,769,1,769]),OVERLAY:h([1,771]),EXCLUSION:h([775,769]),LIGHTEN:h([1,1],[32776]),DARKEN:h([1,1],[32775]),SHADOW:h([774,768])};class o{constructor(){this.target=3553,this.wrapS=this.wrapT=33071,this.internalFormat=this.format=6408,this.minFilter=this.magFilter=9729,this.maxMipMapLevel=this.baseMipMapLevel=0,this.type=5121,this.$currentAglId=this._currentActiveId=-1,this.$updated=!0,this.$width=this.$height=1}get width(){return this.$width}get height(){return this.$height}get wrapS(){return this._wrapS}set wrapS(t){this._wrapS=t,this.$updated=!0}get wrapT(){return this._wrapT}set wrapT(t){this._wrapT=t,this.$updated=!0}get internalFormat(){return this._internalFormat}set internalFormat(t){this._internalFormat=t,this.$updated=!0}get format(){return this._format}set format(t){this._format=t,this.$updated=!0}get minFilter(){return this._minFilter}set minFilter(t){this._minFilter=t,this.$updated=!0}get magFilter(){return this._magFilter}set magFilter(t){this._magFilter=t,this.$updated=!0}get maxMipMapLevel(){return this._maxMipMapLevel}set maxMipMapLevel(t){this._maxMipMapLevel=t,this.$updated=!0}get baseMipMapLevel(){return this._baseMipMapLevel}set baseMipMapLevel(t){this._baseMipMapLevel=t,this.$updated=!0}get type(){return this._type}set type(t){this._type=t,this.$updated=!0}useActiveTexture(t,e){this.activeTexture(t,e),this.useTexture(t)}useActiveTextureAfterUpdate(t,e){this.activeTexture(t,e),this.useTextureAfterUpdate(t)}unbindTexture(t,e){this.activeTexture(t,e),this._currentActiveId=-1,t.bindTexture(this.target,null)}activeTexture(t,e){this._currentActiveId=e,t.activeTexture(33984+e)}bindActiveTexture(t,e){this.activeTexture(t,e),t.bindTexture(this.target,this._baseTexture)}useTexture(t){t.bindTexture(this.target,this._baseTexture),this.createTexImage2D(t)}useTextureAfterUpdate(t){t.bindTexture(this.target,this._baseTexture),this.uploadTextureInfo(t)}createTexImage2D(t){t.texImage2D(this.target,0,this._internalFormat,this.width,this.height,0,this._format,this._type,this.$renderSource),this.uploadTextureInfo(t)}uploadTextureInfo(t){const e=this.target;t.texParameteri(e,10242,this._wrapS),t.texParameteri(e,10243,this._wrapT),t.texParameteri(e,10241,this._minFilter),t.texParameteri(e,10240,this._magFilter),t.texParameteri(e,33085,this._maxMipMapLevel),t.texParameteri(e,33084,this._baseMipMapLevel),t.generateMipmap(e)}}const c=()=>{},u=t=>()=>t,d=(t,e)=>{const s=t.indexOf(e);s>-1&&t.splice(s,1)};class l{constructor(t={}){this.contextId=0,this.isLost=u(1),this._config=i.initContextConfig(t),this._onContextLost=this._onContextLost.bind(this),this._initContext=this._initContext.bind(this);const e=this._config.canvas;this.canvas=e,e.addEventListener("webglcontextlost",this._onContextLost),e.addEventListener("webglcontextrestored",this._initContext),this._initContext()}useBlendMode(t){this._currentBlendMode=t;const e=this.gl;e[t.equationName].apply(e,t.equations),e[t.functionName].apply(e,t.functions)}setBlendMode(t,e){this._currentBlendMode!==t&&(e&&e(),this.useBlendMode(t))}destruct(){this.gl.useProgram(null);const t=this.canvas;t.removeEventListener("webglcontextlost",this._onContextLost),t.removeEventListener("webglcontextrestored",this._initContext),this._loseContext()}clearTextures(){const t=i.INFO.maxTextureImageUnits;let e=-1;for(;++e<t;)this._textureMap[e]=null,this._emptyTextureSlots[e]=e,this._setTextureSizeAt(e,0,0);this.textureIds.length=this.textureSizes.length=0}useTexture(t,e,s=!0,i){if(!t)return-1;let r=this._textureMap.indexOf(t);return r<0&&(this._emptyTextureSlots.length?r=this._emptyTextureSlots[0]:(i&&i(),this.clearTextures(),r=0),s=!0),this.useTextureAt(t,r,e,s)}useTextureAt(t,e,s,i=!0){return t.use(this.gl,e,i,s),this._textureMap[e]=t,this._setTextureSizeAt(e,t.width,t.height),!this.textureIds.includes(e)&&this.textureIds.push(e),d(this._emptyTextureSlots,e),e}deactivateTexture(t){const e=this._textureMap.indexOf(t);e>-1&&t.unbindTexture(this.gl,e)}useProgram(t,e){if(this._currentProgram!==t){this._currentProgram=t,this.clearTextures();const s=this.gl;s.bindVertexArray(null),s.useProgram(t),s.bindVertexArray(e)}}setCanvasSize(t,e){const s=this.canvas;s.width=t,s.height=e}setSize(t,e){if(this._width!==t||this._height!==e){this._width=t,this._height=e;const s=this.gl;s.viewport(0,0,t,e),s.scissor(0,0,t,e)}}_setTextureSizeAt(t,e,s){this.textureSizes[2*t]=e,this.textureSizes[2*t+1]=s}_onContextLost(t){t.preventDefault(),setTimeout(this._restoreContext,1)}_initContext(){const t=this.gl=this.canvas.getContext("webgl2",this._config.contextAttributes);t.gl_id=++this.contextId;const e=t.getExtension("WEBGL_lose_context");e?(this._restoreContext=e.restoreContext.bind(e),this._loseContext=e.loseContext.bind(e)):this._restoreContext=this._loseContext=c,this.isLost=t.isContextLost?t.isContextLost.bind(t):u(1),t.pixelStorei(37441,!0),t.enable(3042),t.blendColor(1,1,1,1),t.enable(3089),this._width=this._height=this._currentProgram=this._currentBlendMode=null,this._textureMap=[],this._emptyTextureSlots=[],this.textureIds=[],this.textureSizes=[],this.clearTextures(),this.setCanvasSize(1,1),this._config.initCallback&&setTimeout(this._config.initCallback,1)}}class p{constructor(t,e,s,i,r,a,h,n){const o=s*i;this.data="number"==typeof e?new Float32Array(e*o):e,this._locationName=t,this._rows=s??1,this._cols=i??1,this._target=r??34962,this._type=a??35048,this._stride=4*o,this._offset=4*i,this._divisor=h??1,this._dataType=n??5126,35044===this._type&&(this._stride=this._offset=0)}create(t,e){this._location=e[this._locationName],this._buffer=t.createBuffer(),this.bind(t)}bind(t){t.bindBuffer(this._target,this._buffer)}upload(t){this.bind(t),this._enable(t),t.bufferData(this._target,this.data,this._type)}destruct(t){this.bind(t),t.deleteBuffer(this._buffer),this.data=this._buffer=null}_enable(t){const e=this._rows,s=this._location,i=this._cols,r=this._stride,a=this._offset,h=this._divisor,n=this._dataType;let o=-1;for(;++o<e;){const e=s+o;t.enableVertexAttribArray(e),t.vertexAttribPointer(e,i,n,!1,r,o*a),t.vertexAttribDivisor(e,h)}}}const g={NONE:0,MULTIPLY:1,GRAYSCALE:2,OVERRIDE:3,ADD:4},f=document.createElement("img"),x=(t,e)=>{const s=document.createElement(t);return s.crossOrigin="anonymous",s.src=e,s};class v extends o{constructor(t,e){super(),this._source=f,this.updateSize=this.updateSize.bind(this),this.source=t,this.shouldUpdate=e,this._currentRenderTime=0}get source(){return this._source}set source(t){this.destruct(),t&&(this._source=t,this.isVideo="video"===t.tagName.toLowerCase(),this._eventType=this.isVideo?"canplay":"load",!this.updateSize()&&t.addEventListener(this._eventType,this.updateSize,{once:!0}))}destruct(){this._source&&this._source.removeEventListener(this._eventType,this.updateSize),this.$renderSource=null}use(t,e,s,i){this.$currentAglId<t.gl_id?(this.$currentAglId=t.gl_id,this._baseTexture=t.createTexture(),this.useActiveTexture(t,e)):this.$updated||this._loaded||this.shouldUpdate&&this._currentRenderTime<i||this.isVideo&&!this._source.paused?(this.$updated=this._loaded=!1,this._currentRenderTime=i,this.useActiveTexture(t,e)):(this._currentActiveId!==e||s)&&this.bindActiveTexture(t,e)}updateSize(){const t=this._source,e=t.videoWidth||t.naturalWidth||t.width,s=t.videoHeight||t.naturalHeight||t.height;if(e*s)return this.$width=e,this.$height=s,this.$renderSource=this._source,this._loaded=this.$updated=!0}}v.loadImage=(t,e)=>new v(x("img",t),e),v.loadVideo=t=>new v(x("video",t));class m extends o{constructor(){super(),this._resized=!0}get width(){return this.$width}set width(t){this.$width!==t&&(this.$width=t,this._resized=!0)}get height(){return this.$height}set height(t){this.$height!==t&&(this.$height=t,this._resized=!0)}setSize(t,e){this.width=t,this.height=e}bind(t){t.bindFramebuffer(36160,this._framebuffer)}unbind(t){t.bindFramebuffer(36160,null)}use(t,e,s){this.$currentAglId<t.gl_id?(this.$currentAglId=t.gl_id,this._baseTexture=t.createTexture(),this.useActiveTexture(t,e),this._framebuffer=t.createFramebuffer(),this.bind(t),t.framebufferTexture2D(36160,36064,3553,this._baseTexture,0),this.unbind(t)):this.$updated?(this.$updated=!1,this.useActiveTextureAfterUpdate(t,e)):this._resized?(this._resized=!1,this.useActiveTexture(t,e)):(this._currentActiveId!==e||s)&&this.bindActiveTexture(t,e)}destruct(){}}class _{constructor(){this._updateRotationFv=c,this.cosRotationA=this.cosRotationB=1,this.sinRotationA=this.sinRotationB=this._x=this._y=this._rotation=this._anchorX=this._anchorY=this._skewX=this._skewY=0}get x(){return this._x}set x(t){this._x=t,this.$transformUpdated=!0}get y(){return this._y}set y(t){this._y=t,this.$transformUpdated=!0}get rotation(){return this._rotation}set rotation(t){this._rotation=t,this._updateRotationFv=this._updateRotation}get anchorX(){return this._anchorX}set anchorX(t){this._anchorX=t,this.$transformUpdated=!0}get anchorY(){return this._anchorY}set anchorY(t){this._anchorY=t,this.$transformUpdated=!0}get skewX(){return this._skewX}set skewX(t){this._skewX=t,this._updateRotationFv=this._updateRotation}get skewY(){return this._skewY}set skewY(t){this._skewY=t,this._updateRotationFv=this._updateRotation}update(){this._updateRotationFv(),this.updated=this.$transformUpdated,this.$transformUpdated=!1}_updateRotation(){if(this._updateRotationFv=c,this.$transformUpdated=!0,this._skewX||this._skewY){const t=this._rotation-this._skewX,e=this._rotation+this._skewY;this.sinRotationA=Math.sin(e),this.cosRotationA=Math.cos(e),this.sinRotationB=Math.sin(t),this.cosRotationB=Math.cos(t)}else this.sinRotationA=this.sinRotationB=Math.sin(this._rotation),this.cosRotationA=this.cosRotationB=Math.cos(this._rotation)}}class C extends _{constructor(){super(),this.$updateScaleFv=c,this.scaledWidth=this.scaledHeight=this._scaleX=this._scaleY=this.$width=this.$height=1}get scaleX(){return this._scaleX}set scaleX(t){this._scaleX=t,this.$updateScaleFv=this.$updateScale}get scaleY(){return this._scaleY}set scaleY(t){this._scaleY=t,this.$updateScaleFv=this.$updateScale}get width(){return this.$width}set width(t){this.$width=t,this.$updateScaleFv=this.$updateScale}get height(){return this.$height}set height(t){this.$height=t,this.$updateScaleFv=this.$updateScale}update(){this.$updateScaleFv(),super.update()}$updateScale(){this.$updateScaleFv=c,this.$transformUpdated=!0,this.scaledWidth=this.$width*this._scaleX,this.scaledHeight=this.$height*this._scaleY}}class y{constructor(){this.cache=new Float32Array(4),this.set(1,1,1,1)}get r(){return this.cache[0]}set r(t){this.cache[0]=t,this._colorUpdated=!0}get g(){return this.cache[1]}set g(t){this.cache[1]=t,this._colorUpdated=!0}get b(){return this.cache[2]}set b(t){this.cache[2]=t,this._colorUpdated=!0}get a(){return this.cache[3]}set a(t){this.cache[3]=t,this._colorUpdated=!0}set(t,e,s,i){this.cache[0]=t,this.cache[1]=e,this.cache[2]=s,this.cache[3]=i,this._colorUpdated=!0}update(){this.updated=this._colorUpdated,this._colorUpdated=!1}}const w=()=>new Float32Array([1,0,0,1,0,0]),T=(t,e)=>{t[0]=2/e.width,t[1]=t[2]=0,t[3]=-2/e.height,t[4]=-1,t[5]=1},R=(t,e)=>{const s=e.anchorX,i=e.anchorY,r=e.scaledWidth,a=e.scaledHeight;t[0]=e.cosRotationA*r,t[1]=e.sinRotationA*r,t[2]=-e.sinRotationB*a,t[3]=e.cosRotationB*a,t[4]=e.x-s*t[0]-i*t[2],t[5]=e.y-s*t[1]-i*t[3]},$=(t,e,s)=>{const i=s.x,r=s.y,a=s.anchorX,h=s.anchorY,n=s.sinRotationA,o=s.sinRotationB,c=s.cosRotationA,u=s.cosRotationB,d=s.scaledWidth,l=s.scaledHeight;t[0]=(c*e[0]+n*e[2])*d,t[1]=(c*e[1]+n*e[3])*d,t[2]=(u*e[2]-o*e[0])*l,t[3]=(u*e[3]-o*e[1])*l,t[4]=-a*t[0]-h*t[2]+i*e[0]+r*e[2]+e[4],t[5]=-a*t[1]-h*t[3]+i*e[1]+r*e[3]+e[5]},L=(t,e)=>{const s=1/(e[0]*e[3]-e[2]*e[1]);t[0]=s*e[3],t[1]=-s*e[1],t[2]=-s*e[2],t[3]=s*e[0],t[4]=s*(e[2]*e[5]-e[3]*e[4]),t[5]=-s*(e[0]*e[5]-e[1]*e[4])},b=(t,e)=>{const s=e.x*t[0]+e.y*t[2]+t[4],i=e.x*t[1]+e.y*t[3]+t[5];return s>=0&&s<=1&&i>=0&&i<=1},F=(t,e,s)=>{const i=s.widthHalf,r=s.heightHalf;t[0].x=i+e[4]*i,t[0].y=s.height-(r+e[5]*r),t[1].x=t[0].x+(e[0]+e[2])*i,t[1].y=t[0].y-(e[1]+e[3])*r,t[2].x=t[0].x+(e[0]+i*e[2]),t[2].y=t[0].y-(e[1]+r*e[3]),t[3].x=t[0].x+(i*e[0]+e[2]),t[3].y=t[0].y-(r*e[1]+e[3])};class A{constructor(){this.RENDERING_TYPE=A.RENDERING_TYPE,this.matrixCache=w(),this.colorCache=new Float32Array([1,1,1,1]),this.transform=new this.$transformClass,this.color=new y,this.alpha=1,this.callbackBeforeRender=this.callbackAfterRender=c,this.renderable=!0,this.$bounds={x:0,y:0,width:0,height:0}}get stage(){return this.$parent?this.$parent.stage:null}get parent(){return this.$parent}set parent(t){this.$parent=t,this._parentChanged=!0}get callbackBeforeRender(){return this._callbackBeforeRender}set callbackBeforeRender(t){this._callbackBeforeRender=t??c}get callbackAfterRender(){return this._callbackAfterRender}set callbackAfterRender(t){this._callbackAfterRender=t??c}callEventHandler(t,e){if(this.interactive){const s=this["on"+e.type];s&&s(this,t,e)}const s=this.$parent;s&&s.callEventHandler(t,e)}destruct(){this.remove()}remove(){const t=this.$parent;t&&t.removeChild(this)}update(){const t=this.transform,e=this.color,s=this.$parent,i=this._parentChanged;if(this._parentChanged=!1,e.update(),this.colorUpdated=i||e.updated||s.colorUpdated,this.colorUpdated){const t=this.colorCache,i=e.cache,r=s.colorCache;t[0]=r[0]*i[0],t[1]=r[1]*i[1],t[2]=r[2]*i[2],t[3]=r[3]*i[3]}t.update(),this.transformUpdated=i||t.updated||s.transformUpdated,this.transformUpdated&&$(this.matrixCache,s.matrixCache,t)}get $transformClass(){return C}}A.RENDERING_TYPE="item";class E extends A{constructor(){super(),this.$corners=[{x:0,y:0},{x:0,y:0},{x:0,y:0},{x:0,y:0}]}getBounds(){this.$calcCorners();const t=this.$corners,e=this.$bounds,s=t[0],i=t[1],r=t[2],a=t[3];return e.x=Math.min(s.x,i.x,r.x,a.x),e.y=Math.min(s.y,i.y,r.y,a.y),e.width=Math.max(s.x,i.x,r.x,a.x),e.height=Math.max(s.y,i.y,r.y,a.y),e}$calcCorners(){this.stage&&F(this.$corners,this.matrixCache,this.stage.renderer)}}class S extends C{constructor(){super(),this.z=0}get width(){return this.$width}set width(t){this.$width=this.$height=t,this.$updateScaleFv=this.$updateScale}get height(){return this.$height}set height(t){this.width=t}}class B extends E{constructor(){super(),this.RENDERING_TYPE=B.RENDERING_TYPE,this.castShadow=this.shading=this.centerReflection=!0,this.angle=0,this.spotAngle=180*i.THETA,this.type=B.Type.POINT,this.precision=this.shadowLength=this.specularStrength=1,this.maxShadowStep=128,this.fading=!0,this.attenuation=1}get castShadow(){return this._castShadow}set castShadow(t){this._castShadow=t,this._updateFlags()}get shading(){return this._shading}set shading(t){this._shading=t,this._updateFlags()}get flattenShadow(){return this._flattenShadow}set flattenShadow(t){this._flattenShadow=t,this._updateFlags()}get fading(){return this._fading}set fading(t){this._fading=t,this._updateFlags()}get centerReflection(){return this._centerReflection}set centerReflection(t){this._centerReflection=t,this._updateFlags()}get $transformClass(){return S}$calcCorners(){super.$calcCorners();const t=this.$corners,e=t[0],s=t[1],i=t[2],r=t[3];e.x+=e.x-r.x+(e.x-i.x),e.y+=e.y-r.y+(e.y-i.y),i.x+=i.x-s.x,i.y+=i.y-s.y,r.x+=r.x-s.x,r.y+=r.y-s.y}_updateFlags(){this.flags=this._castShadow|2*this._shading|4*this._flattenShadow|8*this._centerReflection|16*this._fading}}B.RENDERING_TYPE="light",B.Type={POINT:0,DIRECTIONAL:1};class I extends _{constructor(){super(),this.repeatRandomCache=new Float32Array([0,0,0,2]),this.repeatX=this.repeatY=1}get repeatX(){return this._repeatX}set repeatX(t){this._repeatX=this.scaledWidth=t,this.$transformUpdated=!0}get repeatY(){return this._repeatY}set repeatY(t){this._repeatY=this.scaledHeight=t,this.$transformUpdated=!0}get repeatRandomRotation(){return this.repeatRandomCache[0]}set repeatRandomRotation(t){this.repeatRandomCache[0]=t}get repeatRandomAlpha(){return this.repeatRandomCache[1]}set repeatRandomAlpha(t){this.repeatRandomCache[1]=t}get repeatRandomBlur(){return this.repeatRandomCache[2]}set repeatRandomBlur(t){this.repeatRandomCache[2]=t}get repeatRandomOffset(){return this.repeatRandomCache[3]}set repeatRandomOffset(t){this.repeatRandomCache[3]=t}}class D{constructor(){this.cache=new Float32Array([0,0,1,1]),this._updateCacheFv=this._updateCache,this._width=this._height=1}get x(){return this.cache[0]}set x(t){this.cache[0]=t,this._updateCacheFv=this._updateCache}get y(){return this.cache[1]}set y(t){this.cache[1]=t,this._updateCacheFv=this._updateCache}get width(){return this._width}set width(t){this._width=t,this._updateCacheFv=this._updateCache}get height(){return this._height}set height(t){this._height=t,this._updateCacheFv=this._updateCache}setRect(t){this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height}update(){this._updateCacheFv(),this.updated=this._cacheUpdated,this._cacheUpdated=!1}_updateCache(){this._updateCacheFv=c,this._cacheUpdated=!0;const t=this.cache;t[2]=this._width-t[0],t[3]=this._height-t[1]}}class M{constructor(){this.distortTexture=!0,this.cache=new Float32Array([0,0,1,0,1,1,0,1])}get topLeftX(){return this.cache[0]}set topLeftX(t){this.cache[0]=t}get topLeftY(){return this.cache[1]}set topLeftY(t){this.cache[1]=t}get topRightX(){return this.cache[2]}set topRightX(t){this.cache[2]=t}get topRightY(){return this.cache[3]}set topRightY(t){this.cache[3]=t}get bottomRightX(){return this.cache[4]}set bottomRightX(t){this.cache[4]=t}get bottomRightY(){return this.cache[5]}set bottomRightY(t){this.cache[5]=t}get bottomLeftX(){return this.cache[6]}set bottomLeftX(t){this.cache[6]=t}get bottomLeftY(){return this.cache[7]}set bottomLeftY(t){this.cache[7]=t}}class P extends E{constructor(t){super(),this.RENDERING_TYPE=P.RENDERING_TYPE,this.texture=t,this.tintType=g.MULTIPLY,this.blendMode=n.NORMAL,this._inverseMatrixCache=new Float32Array(6),this.textureMatrixCache=w(),this.textureTransform=new I,this.textureCrop=new D,this.distortion=new M,this.textureCropCache=this.textureCrop.cache,this.textureRepeatRandomCache=this.textureTransform.repeatRandomCache,this.distortionCache=this.distortion.cache}update(){super.update(),this.textureCrop.update();const t=this.textureTransform;t.update(),t.updated&&R(this.textureMatrixCache,t),this.interactive&&this.transformUpdated&&L(this._inverseMatrixCache,this.matrixCache)}isContainsPoint(t){return b(this._inverseMatrixCache,t)}}P.RENDERING_TYPE="drawable";class N extends A{constructor(){super(),this.RENDERING_TYPE=N.RENDERING_TYPE,this.children=[],this.useTint=!0}get parent(){return this.$parent}set parent(t){super.parent=t,t?(this._getParentPremultipliedUseTint=t.getPremultipliedUseTint.bind(t),this._getParentPremultipliedAlpha=t.getPremultipliedAlpha.bind(t)):this._getParentPremultipliedUseTint=this._getParentPremultipliedAlpha=u(1)}getPremultipliedUseTint(){return this.useTint*this._getParentPremultipliedUseTint()}getPremultipliedAlpha(){return this.alpha*this._getParentPremultipliedAlpha()}destruct(){this.empty(),super.destruct()}empty(){for(;this.children.length;)this.removeChildAt(0)}contains(t){return this.getChildIndex(t)>-1}addChild(t){this.addChildAt(t,this.children.length)}addChildAt(t,e){t&&(t.remove(),this.children.push(t),this.setChildIndex(t,e),t.parent=this)}removeChild(t){t&&(d(this.children,t),t.parent=null)}removeChildAt(t){this.removeChild(this.getChildAt(t))}getChildAt(t){return this.children[t]}setChildIndex(t,e){d(this.children,t),this.children.splice(e,0,t)}getChildIndex(t){return this.children.indexOf(t)}swapChildren(t,e){const s=this.getChildIndex(t),i=this.getChildIndex(e);s>-1&&i>-1&&(this.setChildIndex(t,i),this.setChildIndex(e,s))}getBounds(){const t=this.$bounds,e=this.children,s=e.length;let i=-1;for(t.x=t.y=1/0,t.width=t.height=-1/0;++i<s;){const s=e[i].getBounds();t.x=Math.min(t.x,s.x),t.y=Math.min(t.y,s.y),t.width=Math.max(t.width,s.width),t.height=Math.max(t.height,s.height)}return t}}N.RENDERING_TYPE="container";const z=(t,e,s,i)=>{let r="";for(let a=0;a<s.length;a++){const h=r+s[a];e.measureText(h).width<=i?r=h:(r&&t.push(r),r=s[a])}r&&t.push(r)};class G{constructor(t){this._clearBeforeRenderFunc=c,this._resizeCalcFv=c,this._rendererId=1,this.width=this.height=this.widthHalf=this.heightHalf=this._currentContextId=this._currentRendererId=this.$renderTime=0,this.setSize(1,1),this.clearColor=new y,this._config=t,this.context=t.context,i.setLocations(t,["aA","uA","uB"]),this._elementArrayBuffer=new p("",new Uint16Array([0,1,3,2]),0,0,34963,35044),this._positionBuffer=new p("aA",new Uint16Array([0,0,1,0,1,1,0,1]),1,2,34962,35044,0,5123)}set clearBeforeRender(t){this._clearBeforeRenderFunc=t?this._clear:c}setSize(t,e){this.width=t,this.height=e,this._resizeCalcFv=this.$resize}renderToFramebuffer(t){this.context.isLost()||(this._switchToProgram(),this.$attachFramebufferAndClear(t),this._renderBatch(t),t.unbind(this.$gl))}render(){this.context.isLost()||(this._switchToProgram(),this.$gl.uniform1f(this.$locations.uA,1),this._clearBeforeRenderFunc(),this._renderBatch())}destruct(){}$attachFramebuffer(t){t.bind(this.$gl),t.setSize(this.width,this.height),this.context.useTexture(t,this.$renderTime,!1),this.context.deactivateTexture(t),this.$gl.uniform1f(this.$locations.uA,-1)}$attachFramebufferAndClear(t){this.$attachFramebuffer(t),this._clearBeforeRenderFunc()}$drawInstanced(t){this.$gl.drawElementsInstanced(5,4,5123,0,t)}$useTextureAt(t,e,s,i){this.$gl.uniform1i(e,this.context.useTextureAt(t,s,this.$renderTime,i))}$useTexture(t,e,s){this.$gl.uniform1i(e,this.context.useTexture(t,this.$renderTime,s))}$uploadBuffers(){const t=this.$gl;this._positionBuffer.upload(t),this._elementArrayBuffer.upload(t)}$createBuffers(){const t=this.$gl,e=this.$locations;this._elementArrayBuffer.create(t,e),this._positionBuffer.create(t,e)}$resize(){this.resized=!0,this._resizeCalcFv=c,this.widthHalf=this.width/2,this.heightHalf=this.height/2}_renderBatch(t){this.$renderTime=Date.now(),this.$render(t)}_switchToProgram(){this.$gl=this.context.gl;const t=this.context.contextId;this._currentContextId!==t||this._currentRendererId!==this._rendererId?(this._currentContextId=t,this._currentRendererId=this._rendererId,this._buildProgram()):this._useProgram(),this.resized=!1,this._resizeCalcFv(),this.context.setSize(this.width,this.height)}_clear(){this.$gl;const t=this.clearColor;this.$gl.clearColor(t.r,t.g,t.b,t.a),this.$gl.clear(16384)}_buildProgram(){const t=this.$gl,e=i.GLSL.VERSION+"precision highp float;\n";this._program=i.createProgram(t,e+this.$createVertexShader(),e+this.$createFragmentShader()),this.$locations=i.getLocationsFor(t,this._program,this._config.locations),this._vao=t.createVertexArray(),this._useProgram(),this.$createBuffers()}_useProgram(){this.context.useProgram(this._program,this._vao)}}class Y extends G{constructor(t){i.setLocations(t,["aB"]),super(t),this.$MAX_RENDER_COUNT=t.maxRenderCount||1e4,this.$matrixBuffer=new p("aB",this.$MAX_RENDER_COUNT,4,4)}$uploadBuffers(){this.$matrixBuffer.upload(this.$gl),super.$uploadBuffers()}$createBuffers(){super.$createBuffers(),this.$matrixBuffer.create(this.$gl,this.$locations)}}const U="vec4 pos=vec4(aA*2.-1.,1,1);gl_Position=pos;gl_Position.y*=uA;",H="vec2(aA.x,1.-aA.y)",k="in vec2 aA;",X="uniform float uA;",O=k+X,Z=(t,e,s)=>"if("+t+">0.)if("+t+"==1.||("+t+"==2.&&"+e+".r=="+e+".g&&"+e+".r=="+e+".b))"+e+"*="+s+";else if("+t+"==3.)"+e+"="+s+";else if("+t+"==4.)"+e+"+="+s+";",V=(t="",e="")=>"if(v>0.){vec2 wh=vec2(v,uJ[1]);ivec2 mn=ivec2(Z.xx),mx=ivec2(ts)-1;"+t+["z","yz","zy","y"].reduce((t,e)=>t+"oCl+=texelFetch(uB,clamp(f+ivec2(Z."+e+"*wh),mn,mx),0);","")+e+"}";const W=(t,e,s=0)=>{let i=e.length;for(;--i>-1;)t[s+i]=e[i];return t};class J extends N{constructor(t){super(),this.renderer=t,this.colorCache=this.color.cache,delete this.parent,delete this.transform}get stage(){return this}getPremultipliedUseTint(){return this.useTint}getPremultipliedAlpha(){return this.alpha}update(){const t=this.color,e=this.renderer;t.update(),this.colorUpdated=t.updated,this.transformUpdated=e.resized,this.transformUpdated&&T(this.matrixCache,e)}}const q="_draw",K="mousemove",j="mousedown",Q="mouseup",tt="click",et="touchstart",st="touchmove",it="touchend",rt="PointerDown",at="PointerMove",ht="PointerUp",nt=[K,j,Q,tt,et,st,it],ot={[tt]:"PointerClick",[j]:rt,[et]:rt,[K]:at,[st]:at,[Q]:ht,[it]:ht};let ct=class{constructor(t={}){this.on=!0,this.data=new Float32Array(10),this.customData=new Float32Array(8),this.kernels=new Float32Array(9),this.intensityX=t.intensityX??t.intensity??t.deg??0,this.intensityY=t.intensityY??t.intensity??0,this.mix=t.mix??1,this.isRadial=t.isRadial??!1,this.centerX=t.centerX??.5,this.centerY=t.centerY??.5,this.invertRadial=t.invertRadial??!1,this.size=t.size??1,this.roundness=t.roundness??1,this.transition=t.transition??1,t.kernels&&W(this.kernels,t.kernels)}get intensity(){return this.data[0]}set intensity(t){this.data[0]=this.data[1]=t}get intensityX(){return this.data[0]}set intensityX(t){this.data[0]=t}get intensityY(){return this.data[1]}set intensityY(t){this.data[1]=t}get mix(){return this.data[2]}set mix(t){this.data[2]=t}get isRadial(){return this.data[3]}set isRadial(t){this.data[3]=t}get centerX(){return this.data[4]}set centerX(t){this.data[4]=t}get centerY(){return this.data[5]}set centerY(t){this.data[5]=t}get invertRadial(){return this.data[6]}set invertRadial(t){this.data[6]=t}get size(){return this.data[7]}set size(t){this.data[7]=t}get roundness(){return this.data[8]}set roundness(t){this.data[8]=t}get transition(){return 1/this.data[9]}set transition(t){this.data[9]=1/t}};class ut extends ct{get GLSL(){return"mat3 kr=uK*v;oCl.rgb=(texelFetch(uB,f-ivec2(1),0)*kr[0].x+texelFetch(uB,f+ivec2(0,-1),0)*kr[0].y+texelFetch(uB,f+ivec2(1,-1),0)*kr[0].z+texelFetch(uB,f+ivec2(-1,0),0)*kr[1].x+oCl*kr[1].y+texelFetch(uB,f+ivec2(1,0),0)*kr[1].z+texelFetch(uB,f+ivec2(-1,1),0)*kr[2].x+texelFetch(uB,f+ivec2(0,1),0)*kr[2].y+texelFetch(uB,f+ivec2(1),0)*kr[2].z).rgb;"}}class dt extends ct{constructor(t){super(t),this.texture=t.texture,this.translateX=t.translateX??0,this.translateY=t.translateY??0,this.cropX=t.cropX??0,this.cropY=t.cropY??0,this.cropWidth=t.cropWidth??1,this.cropHeight=t.cropHeight??1}get translateX(){return this.customData[0]}set translateX(t){this.customData[0]=t}get translateY(){return this.customData[1]}set translateY(t){this.customData[1]=t}get cropX(){return this.customData[2]}set cropX(t){this.customData[2]=t}get cropY(){return this.customData[3]}set cropY(t){this.customData[3]=t}get cropWidth(){return this.customData[4]}set cropWidth(t){this.customData[4]=t}get cropHeight(){return this.customData[5]}set cropHeight(t){this.customData[5]=t}}dt.$createGLSL=t=>"vec4 txCl=texture(uH,mod(vec2(uL[0].x,uL[0].y)+v0.zw,1.)*vec2(uL[1].x-uL[0].z,uL[1].y-uL[0].w));"+t;const lt=dt.$createGLSL("oCl=texture(uB,v0.zw+(Z.yz*(txCl.rg-.5)*2.*vol));");const pt=dt.$createGLSL("int v2=int(uL[1].z);oCl.a*=v2<4?txCl[v2]:(txCl.r+txCl.g+txCl.b+txCl.a)/4.;");class gt extends dt{constructor(t){super(t),this.type=t.type??gt.Type.RED}get GLSL(){return pt}get type(){return this.customData[6]}set type(t){this.customData[6]=t}}gt.Type={RED:0,GREEN:1,BLUE:2,ALPHA:3,AVG:4};class ft extends BaseFilter{get GLSL(){return"vec3 sv=(1.-v)*vec3(.3,.59,.11);mat3 kr=mat3(sv.r+v,sv.g,sv.b,sv.r,sv.g+v,sv.b,sv.r,sv.g,sv.b+v);oCl.rgb=vec3(kr[0].r*oCl.r+kr[0].g*oCl.g+kr[0].b*oCl.b,kr[1].r*oCl.r+kr[1].g*oCl.g+kr[1].b*oCl.b,kr[2].r*oCl.r+kr[2].g*oCl.g+kr[2].b*oCl.b);"}}const xt=V("","oCl*=.2;");const vt=V("float l=dot(oCl.rgb,vec3(.2126,.7152,.0722)),k=uL[0].x*.5,t=max(l-uL[0].x+k,.0);oCl.rgb*=t*t/(k+1e-5);","oCl=tmpCl+oCl*.2;");window.PWGL=window.AGL={version:"7.0.0",BlendMode:n,TintType:g,Texture:v,Framebuffer:m,Context:l,Buffer:p,Utils:i,Const:r,Item:A,BaseDrawable:E,Light:B,AnimatedImage:class extends P{constructor(t){super(t),this._frame=0,this.frameLength=this._currentFrameLength=120,this._frames=[],this._currentRenderTime=Date.now(),this.stop()}get frames(){return this._frames}set frames(t){this._frames=t;const e=this._frames[0];e&&(this._currentFrameLength=e.length??this.frameLength,this._currentRenderTime=Date.now())}gotoAndStop(t){this.stop(),this._frame=t,this._useTextureFrame()}gotoAndPlay(t){this._frame=t,this.play()}stop(){this._updateAnimationFv=c,this.isPlaying=!1}play(){this._updateAnimationFv=this._updateAnimation,this.isPlaying=!0,this._useTextureFrame()}update(t){super.update(),this._updateAnimationFv(t)}destruct(){this.stop(),super.destruct()}_updateAnimation(t){const e=t-this._currentRenderTime;e>this._currentFrameLength&&(this._currentRenderTime=t,this._frame+=~~(e/this._currentFrameLength),this._frame>=this._frames.length&&(this._frame=0),this._useTextureFrame())}_useTextureFrame(){const t=this._frames[this._frame];this.textureCrop.setRect(t),this._currentFrameLength=t.length??this.frameLength}},Container:N,Image:P,Text:class extends P{constructor(t="",e={}){const s=document.createElement("canvas");super(new v(s,!0)),this._canvas=s,this._ctx=s.getContext("2d",{alpha:!0}),this.text=t,this.fontSize=e.fontSize??12,this.lineHeight=e.lineHeight??1.3,this.fontFamily=e.fontFamily??"sans-serif",this.fontColor=e.fontColor??"#000",this.align=e.align??"left"}get text(){return this._text}set text(t){this._text=t,this._updateFv=this._updateTexture}get fontSize(){return this._fontSize}set fontSize(t){this._fontSize=t,this._updateFv=this._updateTexture}get fontFamily(){return this._fontFamily}set fontFamily(t){this._fontFamily=t,this._updateFv=this._updateTexture}get fontColor(){return this._fontColor}set fontColor(t){this._fontColor=t,this._updateFv=this._updateTexture}get align(){return this._align}set align(t){this._align=t,this._updateFv=this._updateTexture}get lineHeight(){return this._lineHeight}set lineHeight(t){this._lineHeight=t,this._updateFv=this._updateTexture}update(){super.update(),this.transformUpdated?this._updateTexture():this._updateFv()}_updateTexture(){this._updateFv=c;const t=this._ctx,e=this._canvas,s=this._align,i=this._fontSize,r=this._lineHeight*i,a=this.transform.width;e.width=this.transform.width,e.height=this.transform.height,t.font=i+"px "+this._fontFamily,t.textBaseline="top",t.textAlign=s,t.fillStyle=this._fontColor;const h=((t,e,s)=>{const i=[],r=e.split("\n");for(let a=0;a<r.length;a++){const e=r[a];if(""===e.trim()){i.push("");continue}let h="",n=0;for(;n<e.length;){let r=e.indexOf(" ",n);-1===r&&(r=e.length);const a=e.slice(n,r),o=h+(""===h?"":" ")+a;if(t.measureText(o).width<=s)h=o;else if(t.measureText(a).width>s)if(h&&(i.push(h),h=""),a.includes("-")){const e=a.split(/(-)/);let r="";for(let a=0;a<e.length;a++){const h=r+e[a];t.measureText(h).width<=s?r=h:(r&&i.push(r),t.measureText(e[a]).width>s?(z(i,t,[...e[a]],s),r=""):r=e[a])}r&&i.push(r)}else z(i,t,[...a],s);else h&&i.push(h),h=a;n=r+1}h&&i.push(h)}return i})(t,this._text,a),n="center"===s?a/2:"right"===s?a:0;for(let o=0,c=h.length;o<c;o++){const e=h[o],s=r*o;t.fillText(e,n,s)}this.texture.updateSize()}},BaseRenderer:G,BatchRenderer:Y,FilterRenderer:class extends G{constructor(t={}){t=i.initRendererConfig(t),i.setLocations(t,["uF","uH","uI","uJ","uK","uL"]),super(t),this._attachFramebufferAndClearFv=this.$attachFramebufferAndClear,this.$attachFramebufferAndClear=c,this.filters=t.filters||[],this.sourceTexture=t.sourceTexture,this._framebuffers=[new m,new m]}get filters(){return this._filters}set filters(t){this._filters=new Proxy(t,{deleteProperty:(t,e)=>(delete t[e],this._rendererId++,!0),set:(t,e,s)=>(t[e]=s,this._rendererId++,!0)}),this._rendererId++}$render(t){const e=this.context,s=this.$gl,i=this.$renderTime,r=this.$locations,a=this._filters,h=a.length||1,o=h-2;let c=-1;for(e.setBlendMode(n.NORMAL),this.$uploadBuffers(),this.$useTextureAt(this.sourceTexture,r.uB,0),s.uniform3f(r.uF,this.width,this.height,i%864e5);++c<h;){const h=a[c],n=h&&h.on,u=c>o,d=n&&h.texture;let l;d&&this.$useTextureAt(d,r.uH,1),u?t?this._attachFramebufferAndClearFv(t):s.uniform1f(r.uA,1):n&&(l=this._framebuffers[1&c],this._attachFramebufferAndClearFv(l)),n&&(s.uniform1i(r.uI,h.uniqueId),s.uniform1fv(r.uJ,h.data),s.uniformMatrix2x4fv(r.uL,!1,h.customData),s.uniformMatrix3fv(r.uK,!1,h.kernels)),(n||u)&&this.$drawInstanced(1),d&&e.deactivateTexture(d),l&&(l.unbind(s),e.useTextureAt(l,0,i))}}$createVertexShader(){return O+"out vec4 v0;void main(){"+U+"v0=vec4(pos.xy,"+H+");}"}$createFragmentShader(){return i.GLSL.DEFINE.Z+i.GLSL.DEFINE.RADIANS_360+"in vec4 v0;uniform float uJ[10];uniform int uI;uniform vec3 uF;uniform mat3 uK;uniform mat2x4 uL;uniform sampler2D uB,uH;out vec4 oCl;"+i.GLSL.RANDOM+"float gs(vec3 c){return .3*c.r+.59*c.g+.11*c.b;}void main(){oCl=texture(uB,v0.zw);vec4 tmpCl=oCl;float v=uJ[0];vec2 ts=floor(uF.xy),vol=v/ts;ivec2 f=ivec2(floor(v0.zw*ts));"+this.filters.reduce((t,e)=>{let s=t.findIndex(t=>t.GLSL===e.GLSL);return s<0&&(s=t.push(e)-1),e.uniqueId=s,t},[]).map(t=>"if(uI=="+t.uniqueId+"){"+t.GLSL+"}").join("else ")+"vec2 d=abs(v0.zw-vec2(uJ[4],uJ[5]));float ds=mix(length(d),pow(pow(d.x,4.)+pow(d.y,4.),.25),uJ[8]),dst=mix(1.,clamp(pow(clamp(ds,0.,1.)/uJ[7],uJ[9]),0.,1.),uJ[3]),mA=mix(dst,1.-dst,uJ[6]);oCl=mix(tmpCl,oCl,mA*uJ[2]);}"}},NormalMapRenderer:class extends G{constructor(t={}){t=i.initRendererConfig(t),i.setLocations(t,["uF"]),super(t),this.heightMap=t.heightMap}$render(){const t=this.$locations;this.context.setBlendMode(n.NORMAL),this.$useTextureAt(this.heightMap,t.uB,0),this.$gl.uniform2f(t.uF,this.width,this.height),this.$uploadBuffers(),this.$drawInstanced(1)}$createVertexShader(){return O+"out vec2 v0;void main(){"+U+"v0="+H+";}"}$createFragmentShader(){return i.GLSL.DEFINE.Z+i.GLSL.DEFINE.HEIGHT+"in vec2 v0;uniform vec2 uF;uniform sampler2D uB;out vec4 oCl;void main(){vec2 ts=floor(uF),p=1./ts,p0=floor(v0.xy*ts);float h0=texture(uB,p0*p).g,h1=texture(uB,(p0+Z.yx)*p).g,h2=texture(uB,(p0+Z.xy)*p).g;vec3 nm=normalize(cross(vec3(1,0,h1-h0),vec3(0,1,h2-h0)))*HEIGHT*Z.yzy;oCl=vec4(nm*.5+.5,1);}"}},AmbientOcclusionMapRenderer:class extends G{constructor(t={}){t=i.initRendererConfig(t),i.setLocations(t,["uC","uD","uE","uF","uG"]),super(t),this.sourceTexture=t.sourceTexture,this.heightMap=t.heightMap,this.radius=t.radius??4,this.samples=t.samples??4,this.multiplier=t.multiplier??1,this.depthMultiplier=t.depthMultiplier??1,this.offsetX=t.offsetX??0,this.offsetY=t.offsetY??0}setOffset(t,e){this.offsetX=t,this.offsetY=e}$render(){const t=this.$gl,e=this.$locations,s=!!this.sourceTexture;this.context.setBlendMode(n.NORMAL),this.$useTextureAt(this.heightMap,e.uB,0),t.uniform2f(e.uF,this.width,this.height),s&&this.$useTextureAt(this.sourceTexture,e.uC,1),t.uniform1f(e.uE,s),t.uniform4f(e.uD,this.radius,this.samples,this.multiplier,this.depthMultiplier),t.uniform2f(e.uG,this.offsetX,this.offsetY),this.$uploadBuffers(),this.$drawInstanced(1)}$createVertexShader(){return i.GLSL.DEFINE.RADIANS_360+O+"uniform vec4 uD;out vec2 v0;flat out vec2 v1;void main(){"+U+"float r=RADIANS_360/uD.y;v0="+H+";v1=vec2(cos(r),sin(r));}"}$createFragmentShader(){return i.GLSL.DEFINE.Z+i.GLSL.DEFINE.RADIANS_360+"in vec2 v0;flat in vec2 v1;uniform sampler2D uB,uC;uniform float uE;uniform vec2 uF,uG;uniform vec4 uD;out vec4 oCl;"+i.GLSL.RANDOM+"void main(){float tx=texture(uB,v0).g,v=0.;if(uD.y>0.&&uD.x>0.){int l=clamp(int(uD.y),1,32);vec2 ts=1./floor(uF);float rnd=rand(v0+floor(uG)*ts),ta=RADIANS_360*rnd,ln=1.-rnd;vec2  rg,n=uD.x*ts*rnd,dr=vec2(cos(ta),sin(ta));for(int i=0;i<l;i++){rg=max(texture(uB,v0+n*dr).rg-tx,Z.xx);v+=max(0.,(rg.y-rg.x)*(1.-rg.x)*ln);dr=vec2(v1.x*dr.x-v1.y*dr.y,v1.y*dr.x+v1.x*dr.y);}v/=float(l);}vec3 stCl=uE>0.?texture(uC,v0).rgb:Z.yyy;oCl=vec4(stCl*mix(1.,tx,uD.w)*(1.-v*uD.z),1);}"}},LightRenderer:class extends Y{constructor(t={}){t=i.initRendererConfig(t),i.setLocations(t,["aC","uC","uF","uM","uN","uO"]),super(t),this.clearBeforeRender=!0,this.clearColor.set(0,0,0,1),this._sizable=this,this.sourceTexture=t.sourceTexture,this.normalMap=t.normalMap,this.heightMap=t.heightMap,this.roughnessMap=t.roughnessMap,this._extensionBuffer=new p("aC",this.$MAX_RENDER_COUNT,2,3)}get sourceTexture(){return this._sourceTexture}set sourceTexture(t){this._sourceTexture=t,t&&(this._sizable=t)}get normalMap(){return this._normalMap}set normalMap(t){this._normalMap=t,t&&(this._sizable=t)}get heightMap(){return this._heightMap}set heightMap(t){this._heightMap=t,t&&(this._sizable=t)}get roughnessMap(){return this._roughnessMap}set roughnessMap(t){this._roughnessMap=t,t&&(this._sizable=t)}addLightForRender(t){const e=this._batchItems,s=t.parent;if(e<this.$MAX_RENDER_COUNT&&s){const i=16*e,r=6*e,a=this.$matrixBuffer.data,h=this._extensionBuffer.data;W(a,t.matrixCache,i),a[i+6]=t.transform.width,a[i+7]=t.spotAngle,W(a,t.colorCache,i+8),a[i+11]*=t.alpha*s.getPremultipliedAlpha(),a[i+12]=t.shadowLength,a[i+13]=t.angle,a[i+14]=t.type,h[r]=t.flags,h[r+1]=t.transform.z,h[r+2]=t.precision,h[r+3]=t.maxShadowStep,h[r+4]=t.specularStrength,h[r+5]=t.attenuation,++this._batchItems}}$render(){const t=this.$gl,e=this.$locations,s=!!this.sourceTexture,i=!!this.normalMap,r=!!this.roughnessMap,a=!!this.heightMap;this.context.setBlendMode(n.ADD),s&&this.$useTexture(this._sourceTexture,e.uC),i&&this.$useTexture(this._normalMap,e.uM),r&&this.$useTexture(this._roughnessMap,e.uN),a&&this.$useTexture(this._heightMap,e.uB),t.uniform3f(e.uO,s,r,i),t.uniform2f(e.uF,this._sizable.width,this._sizable.height),this.$uploadBuffers(),this.$drawInstanced(this._batchItems),this._batchItems=0}$uploadBuffers(){this._extensionBuffer.upload(this.$gl),super.$uploadBuffers()}$createBuffers(){super.$createBuffers(),this._extensionBuffer.create(this.$gl,this.$locations)}$createVertexShader(){return i.GLSL.DEFINE.Z+i.GLSL.DEFINE.PI+"#define P vec4(1,-1,2,-2)\n"+k+"in mat4 aB;in mat2x3 aC;"+X+"out vec2 v0;out vec4 v1;flat out vec4 v2,v3,v4,v5;void main(){vec3 pos=vec3(aA*2.-1.,1);v1.xy=pos.xy;mat3 mt=mat3(aB[0].xy,0,aB[0].zw,0,aB[1].xy,1);v2.x=aB[1].z;v2.y=v2.x*aB[3].x;v3=vec4(aC[1],PI-aB[1].w);v4=vec4(aB[3].z,aC[0]);v5=aB[2];if(v4.x<1.){gl_Position=vec4(mt*pos,1);v0=(gl_Position.xy+P.xy)/P.zw;v1.zw=(aB[1].xy+P.xy)/P.zw;v2.zw=vec2(sin(aB[3].y),cos(aB[3].y));}else{mt[2].xy=Z.zy;gl_Position=vec4(pos,1);v0=(gl_Position.xy+P.xy)/P.zw;v1.zw=v0+((mt*vec3(1)).xy+P.xy)/P.zw;}gl_Position.y*=uA;}"}$createFragmentShader(){const t=t=>"for(i=m;i<l;i+=st){p=ivec2((v1.zw+i*opdm)*uF);tc=texelFetch(uB,p,0)*HEIGHT;"+t+"}";return i.GLSL.DEFINE.HEIGHT+i.GLSL.DEFINE.Z+"in vec2 v0;in vec4 v1;flat in vec4 v2,v3,v4,v5;uniform vec2 uF;uniform vec3 uO;uniform sampler2D uB,uC,uM,uN;out vec4 oCl;"+i.GLSL.RANDOM+"void main(){float vol=v5.a;if(vol<=0.)discard;vec2 tUv=v0*uF,tCnt=v1.zw*uF;vec4 tc=texelFetch(uB,ivec2(tUv),0);int flg=int(v4.y);float ph=tc.g*HEIGHT,spc=0.;vec3 sf=vec3(tUv,ph),lp=vec3(tCnt,v4.z),sftla=lp-sf;if(v4.x<1.){float d=length(sftla)/v2.x,od=1.-d,dv=(flg&16)>0?pow(od,v3.z):1.;vol*=dv;float slh=(v4.z-ph)/HEIGHT;vec2 sl=vec2(slh*v2.w-v1.x*v2.z,slh*v2.z+v1.x*v2.w);if(vol<=0.||od<=0.||atan(sl.x,length(vec2(sl.y,v1.y)))+"+i.ALPHA+"-v3.w<0.)discard;}float fltDst=distance(tCnt,tUv),shdw=1.;if((flg&2)>0){vec3 nm=uO.z>0.?normalize((texture(uM,v0).rgb*2.-1.)*Z.yzy):Z.xxy,sftl=normalize(sftla),sftv=normalize(vec3((flg&8)>0?uF*.5:tUv,HEIGHT)-sf),hlf=normalize(sftl+sftv);vol*=dot(nm,sftl);if(vol<=0.)discard;float rgh=1.,shn=uO.y>0.?texture(uN,v0).r:tc.b;spc=pow(max(dot(nm,hlf),0.),32.)*shn*v3.y;}if((flg&1)>0){ivec2 p;vec2 opd=(tUv-tCnt)/fltDst,opdm=opd/uF;float i,pc,st=max(1.,ceil(fltDst/v3.x)),l=min(fltDst-st,4096.),m=max(st,l-v2.y);if((flg&4)>0)"+t("if(tc.g>=v4.z)discard;")+"else{float opdL=length(opd),hst=(ph-v4.z)/fltDst,rnd=v4.w*rand(v0);"+t("st+=rnd;pc=v4.z+i*hst;shdw*=mix(1.,(fltDst-i*opdL)/v2.y,step(tc.r,pc)*step(pc,tc.g));")+"}}vec3 stCl=uO.x>0.?texture(uC,v0).rgb:Z.yyy;oCl=vec4((stCl+spc)*v5.rgb*vol*shdw,1);}"}},Stage2D:class extends Y{constructor(t={}){(t=i.initRendererConfig(t)).useTint=t.useTint??!0,i.setLocations(t,["aD","aE","uF"]),super(t);const e=this.$MAX_RENDER_COUNT;this.container=new J(this),this._batchItems=0,this[q+A.RENDERING_TYPE]=this[q+B.RENDERING_TYPE]=c,this[q+P.RENDERING_TYPE]=this._drawImage,this[q+N.RENDERING_TYPE]=this._drawContainer,this._batchDraw=this._batchDraw.bind(this),this._mousePosition={x:0,y:0},this._dataBuffer=new p("aD",e,3,4),this._distortionBuffer=new p("aE",e,4,2),this._onMouseEventHandler=this._onMouseEventHandler.bind(this);const s=this.context.canvas,r=t.lightRenderer;nt.forEach(t=>s.addEventListener(t,this._onMouseEventHandler)),r&&this.attachLightRenderer(r)}attachLightRenderer(t){this[q+B.RENDERING_TYPE]=t.addLightForRender.bind(t)}detachLightRenderer(){this[q+B.RENDERING_TYPE]=c}destruct(){const t=this.context.canvas;nt.forEach(e=>t.removeEventListener(e,this._onMouseEventHandler))}_handleMouseEvent(){const t=this._latestEvent,e=this._eventTarget,s=this._previousEventTarget;if(t){if(e!==s){const i={...t};s&&s.callEventHandler(s,{...i,type:"PointerOut"}),e&&e.callEventHandler(e,{...i,type:"PointerOver"})}e&&e.callEventHandler(e,{...t,type:ot[t.type]}),this._previousEventTarget=e}this._latestEvent=null}_setMousePosition(t,e){this._isMousePositionSet=!0;const s=this.container.matrixCache,i=this._mousePosition;i.x=(t-this.widthHalf)*s[0],i.y=(e-this.heightHalf)*s[3]}_drawItem(t){const e=this.$renderTime;t.update(e),t.callbackBeforeRender(t,e),t.renderable&&this[q+t.RENDERING_TYPE](t),t.callbackAfterRender(t,e)}_drawContainer(t){const e=t.children,s=e.length;let i=-1;for(;++i<s;)this._drawItem(e[i])}_drawImage(t){this.context.setBlendMode(t.blendMode,this._batchDraw);const e=this._batchItems,s=12*e,i=16*e,r=t.parent,a=this._dataBuffer.data,h=this.$matrixBuffer.data;r&&(this._isMousePositionSet&&t.interactive&&t.isContainsPoint(this._mousePosition)&&(this._eventTarget=t),W(a,t.colorCache,s),W(a,t.textureRepeatRandomCache,s+8),a[s+4]=t.alpha*r.getPremultipliedAlpha(),a[s+5]=t.tintType*r.getPremultipliedUseTint(),a[s+6]=this.context.useTexture(t.texture,this.$renderTime,!1,this._batchDraw),a[s+7]=t.distortion.distortTexture,W(h,t.matrixCache,i),W(h,t.textureMatrixCache,i+6),W(h,t.textureCropCache,i+12),W(this._distortionBuffer.data,t.distortionCache,8*e),++this._batchItems===this.$MAX_RENDER_COUNT&&this._batchDraw())}_batchDraw(){const t=this.$gl,e=this.$locations,s=this.context,i=this._batchItems;i&&(s.textureIds.length&&(t.uniform1iv(e.uB,s.textureIds),t.uniform2fv(e.uF,s.textureSizes)),this.$uploadBuffers(),this.$drawInstanced(i),this._batchItems=0)}_onMouseEventHandler(t){this._latestEvent=t;const e=this.context.canvas;this._setMousePosition(e.width/e.offsetWidth*t.offsetX,e.height/e.offsetHeight*t.offsetY)}$render(){this._eventTarget=null,this._drawItem(this.container),this._batchDraw(),this._isMousePositionSet=!1,this._handleMouseEvent()}$uploadBuffers(){const t=this.$gl;this._dataBuffer.upload(t),this._distortionBuffer.upload(t),super.$uploadBuffers()}$createBuffers(){const t=this.$gl,e=this.$locations;super.$createBuffers(),this._dataBuffer.create(t,e),this._distortionBuffer.create(t,e)}$createVertexShader(){const t=this._config.useRepeatTextures,e=i.INFO.maxTextureImageUnits;return i.GLSL.DEFINE.Z+k+"in mat4x2 aE;in mat3x4 aD;in mat4 aB;"+X+"uniform vec2 uF["+e+"];out vec2 v0;flat out float v1;flat out vec4 v2,v3,v4"+(t?",v5;":";")+"vec2 clcQd(vec2 p){return mix(mix(aE[0],aE[1],p.x),mix(aE[3],aE[2],p.x),p.y);}void main(){vec2 tPs=clcQd(aA);gl_Position=vec4(mat3(aB[0].xy,0,aB[0].zw,0,aB[1].xy,1)*vec3(tPs,1.),1)*vec4(1.,uA,1.,1.);v0=(mat3(aB[1].zw,0,aB[2].xy,0,aB[2].zw,1)*vec3(mix(tPs,aA,aD[1].w),1.)).xy;v1=aD[1].x;v2.xy=aD[1].yz;v2.zw=v2.y>-1.?.5/uF[int(v2.y)]:Z.yy;v3=aB[3];v4=aD[0];"+(t?"v5=aD[2];":"")+"}"}$createFragmentShader(){const t=this._config,e=i.INFO.maxTextureImageUnits,s=t.useRepeatTextures,r=t.useTint,a=t=>"gTxC(v2.y,v3,"+t+")";return i.GLSL.DEFINE.Z+i.GLSL.DEFINE.RADIANS_360+"in vec2 v0;flat in float v1;flat in vec4 v2,v3,v4"+(s?",v5;":";")+"uniform sampler2D uB["+e+"];out vec4 oCl;vec4 gTxC(float i,vec4 s,vec2 m){vec2 sxy=s.xy,szw=s.zw,ofs=szw*m,cp=clamp(sxy+ofs,sxy+v2.zw,sxy+szw-v2.zw);"+Array(e).fill().map((t,e)=>"if(i<"+(e+1)+".)return texture(uB["+e+"],cp);").join("")+"return Z.yyyy;}float cs(float a,float b,float v){v=abs(v);float t=-2.*v+2.;v=mix(2.*v*v,1.-t*t*.5,step(.5,v));return a*(1.-v)+b*v;}"+(s?i.GLSL.RANDOM2+"vec4 gCB(vec2 st){vec2 uv=v0;float rnd=rand2(floor(uv+st)/100.),rndDg=rnd*RADIANS_360*v5.x;if(rndDg>0.){vec2 rt=vec2(sin(rndDg),cos(rndDg));uv=vec2(uv.x*rt.y-uv.y*rt.x,uv.x*rt.x+uv.y*rt.y);}return "+a("mod(uv,Z.yy)")+";}float gRCB(vec2 st,vec2 uv){float rnd=rand2(floor(v0+st)/100.);return (1.-(v5.w*rnd-v5.w*.5)*v5.y)*cs(0.,1.,1.-st.x-uv.x)*cs(0.,1.,1.-st.y-uv.y);}":"")+"void main(){if(v2.y>-1.){vec2 uv=mod(v0,Z.yy);"+(s?"if(v5.x>0.||v5.y>0.){vec4 rc=vec4(gRCB(Z.xx,uv),gRCB(Z.yx,uv),gRCB(Z.xy,uv),gRCB(Z.yy,uv));oCl=mix(gCB(Z.xy),clamp(gCB(Z.xx)*rc.x+gCB(Z.yx)*rc.y+gCB(Z.xy)*rc.z+gCB(Z.yy)*rc.w,0.,1.),vec4(v5.z));oCl.a=mix(oCl.a,clamp(oCl.a*(rc.x+rc.y+rc.z+rc.w),0.,1.),v5.y);}else oCl="+a("uv")+";":"oCl="+a("uv")+";")+"}else oCl+=1.;oCl.a*=v1;if(oCl.a<=0.)discard;"+(r?Z("v2.x","oCl","v4"):"")+"}"}},BaseFilter:ct,BaseKernelFilter:ut,BaseTextureFilter:dt,DisplacementFilter:class extends dt{get GLSL(){return lt}},MaskFilter:gt,PixelateFilter:class extends ct{get GLSL(){return"oCl=texture(uB,floor(v0.zw/vol)*vol);"}},EdgeDetectFilter:class extends ut{constructor(t){super({...t,kernels:[-1,-1,-1,-1,8,-1,-1,-1,-1]})}},SharpenFilter:class extends ut{constructor(t){super({...t,kernels:[0,-1,0,-1,5,-1,0,-1,0]})}},SaturateFilter:ft,GrayscaleFilter:class extends ct{get GLSL(){return"oCl=vec4(vec3(gs(oCl.rgb)),oCl.a);"}},SepiaFilter:class extends ct{get GLSL(){return"oCl=vec4(vec3(.874,.514,.156)*gs(oCl.rgb),oCl.a);"}},InvertFilter:class extends ct{get GLSL(){return"oCl=vec4(1.-oCl.rgb,oCl.a);"}},TintFilter:class extends ct{constructor(t){super(t),this.set(t.r??1,t.g??1,t.b??1,t.a??1),this.tintType=g.MULTIPLY}get GLSL(){return Z("uL[1].x","oCl","uL[0]")}get r(){return this.customData[0]}set r(t){this.customData[0]=t}get g(){return this.customData[1]}set g(t){this.customData[1]=t}get b(){return this.customData[2]}set b(t){this.customData[2]=t}get a(){return this.customData[3]}set a(t){this.customData[3]=t}get tintType(){return this.customData[4]}set tintType(t){this.customData[4]=t}set(t,e,s,i){this.r=t,this.g=e,this.b=s,this.a=i}},PosterizeFilter:class extends ct{get GLSL(){return"float l=dot(oCl.rgb,vec3(.299,.587,.114)),q=floor(l*v+.5)/v;oCl.rgb*=q/max(l,1e-5);"}},RainbowFilter:class extends ct{get GLSL(){return"oCl.rgb+=vec3(v0.xy*.15,(v0.x*v0.y)*.15)*v;"}},BrightnessFilter:class extends ct{get GLSL(){return"oCl.rgb*=v;"}},ContrastFilter:class extends ct{get GLSL(){return"oCl.rgb=(oCl.rgb-.5)*v+.5;"}},HueRotateFilter:class extends ct{get GLSL(){return"float ca=cos(v),sa=sin(v);oCl.rgb*=mat3(.299+.701*ca+.168*sa,.587-.587*ca+.330*sa,.114-.114*ca-.497*sa,.299-.299*ca-.328*sa,.587+.413*ca+.035*sa,.114-.114*ca+.292*sa,.299-.300*ca+1.250*sa,.587-.588*ca-1.050*sa,.114+.886*ca-.203*sa);"}},GammaFilter:class extends ct{get GLSL(){return"oCl.rgb=pow(oCl.rgb,vec3(1./v));"}},BlurFilter:class extends ct{get GLSL(){return xt}},GlowFilter:class extends ct{constructor(t){super(t),this.threshold=t.threshold??.7}get GLSL(){return vt}get threshold(){return this.customData[0]}set threshold(t){this.customData[0]=t}},ChromaticAberrationFilter:class extends ct{get GLSL(){return"vec2 am=vec2(vol.x,0);oCl=vec4(texture(uB,v0.zw-am).r,oCl.g,texture(uB,v0.zw+am).b,1);"}}},console.log(`%cPWGL v${AGL.version}\nhttps://github.com/asjs-dev/pwgl`,"background:#222;color:#0F0")});
