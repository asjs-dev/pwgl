const t=()=>{},e=t=>()=>t,s=(t,e)=>{const s=t.indexOf(e);s>-1&&t.splice(s,1)},i={a:"Attrib",u:"Uniform"},r=(t,e,s)=>{const i=t.createShader(s);return t.shaderSource(i,e),t.compileShader(i),i},h=Math.PI/180,a={ALPHA:90*h,THETA:h,GLSL:{VERSION:"#version 300 es\n",DEFINE:{RADIANS_360:"#define RADIANS_360 radians(360.)\n",HEIGHT:"#define HEIGHT 255.\n",Z:"#define Z vec3(0,1,-1)\n",PI:`#define PI ${Math.PI}\n`},RANDOM:"float rand(vec2 p,float s){return fract(sin((p.x*12.9898+p.y*78.233)*s)*43758.5453);}float rand(vec2 p){return rand(p,1.);}",RANDOM2:"float rand2(vec2 p,float s){p=mod(p*100.,vec2(1e4))+100.;return fract(dot(p,vec2(sin(p.x+p.y),cos(p.y-p.x))*s));}float rand2(vec2 p){return rand2(p,1.);}"},INFO:{isWebGl2Supported:!1},initContextConfig:(t={})=>({canvas:document.createElement("canvas"),...t,contextAttributes:{powerPreference:"high-performance",preserveDrawingBuffer:!1,premultipliedAlpha:!1,...t.contextAttributes||{}}}),initRendererConfig:(t={})=>({...t,locations:t.locations??[],context:(t.config&&t.config.context)??t.context??new l}),setLocations:(t,e)=>t.locations=[...t.locations,...e],initApplication:t=>{const e=()=>t(a.INFO.isWebGl2Supported);["interactive","complete"].includes(document.readyState)?e():document.addEventListener("DOMContentLoaded",e,{once:!0})},createProgram:(t,e,s)=>{const i=r(t,e,35633),h=r(t,s,35632),a=t.createProgram();if(t.attachShader(a,i),t.attachShader(a,h),t.linkProgram(a),!t.getProgramParameter(a,35714)){const r=t.getShaderInfoLog(i),n=t.getShaderInfoLog(h);throw console.error(["Program info: "+t.getProgramInfoLog(a),"Validate status: "+t.getProgramParameter(a,35715),...r?["","Vertex shader info: "+r,"Vertex shader: "+e]:[],...n?["","Fragment shader info: "+n,"Fragment shader: "+s]:[]].join("\n")),t.deleteShader(i),t.deleteShader(h),t.deleteProgram(a),"WebGL application stoped"}return a},getLocationsFor:(t,e,s)=>{const r={};return s.forEach(s=>r[s]=t[`get${i[s[0]]}Location`](e,s)),r}},n={},o=document.createElement("canvas").getContext("webgl2");if(o){for(let t in o){const e=o[t];"number"==typeof e&&t===t.toUpperCase()&&(n[t]=e)}a.INFO.isWebGl2Supported=!0,a.INFO.maxTextureImageUnits=o.getParameter(34930)}class c{constructor(){this.target=3553,this.wrapS=this.wrapT=33071,this.internalFormat=this.format=6408,this.minFilter=this.magFilter=9729,this.maxMipMapLevel=this.baseMipMapLevel=0,this.type=5121,this.$currentAglId=this._currenActiveId=-1,this.$updated=!0,this.$width=this.$height=1}get width(){return this.$width}get height(){return this.$height}get wrapS(){return this._wrapS}set wrapS(t){this._wrapS=t,this.$updated=!0}get wrapT(){return this._wrapT}set wrapT(t){this._wrapT=t,this.$updated=!0}get internalFormat(){return this._internalFormat}set internalFormat(t){this._internalFormat=t,this.$updated=!0}get format(){return this._format}set format(t){this._format=t,this.$updated=!0}get minFilter(){return this._minFilter}set minFilter(t){this._minFilter=t,this.$updated=!0}get magFilter(){return this._magFilter}set magFilter(t){this._magFilter=t,this.$updated=!0}get maxMipMapLevel(){return this._maxMipMapLevel}set maxMipMapLevel(t){this._maxMipMapLevel=t,this.$updated=!0}get baseMipMapLevel(){return this._baseMipMapLevel}set baseMipMapLevel(t){this._baseMipMapLevel=t,this.$updated=!0}get type(){return this._type}set type(t){this._type=t,this.$updated=!0}useActiveTexture(t,e){this.activeTexture(t,e),this.useTexture(t)}useActiveTextureAfterUpdate(t,e){this.activeTexture(t,e),this.useTextureAfterUpdate(t)}unbindTexture(t,e){this.activeTexture(t,e),this._currenActiveId=-1,t.bindTexture(this.target,null)}activeTexture(t,e){this._currenActiveId=e,t.activeTexture(33984+e)}bindActiveTexture(t,e){this.activeTexture(t,e),t.bindTexture(this.target,this._baseTexture)}useTexture(t){t.bindTexture(this.target,this._baseTexture),this.createTexImage2D(t)}useTextureAfterUpdate(t){t.bindTexture(this.target,this._baseTexture),this.uploadTextureInfo(t)}createTexImage2D(t){t.texImage2D(this.target,0,this._internalFormat,this.width,this.height,0,this._format,this._type,this.$renderSource),this.uploadTextureInfo(t)}uploadTextureInfo(t){t.texParameteri(this.target,10242,this._wrapS),t.texParameteri(this.target,10243,this._wrapT),t.texParameteri(this.target,10241,this._minFilter),t.texParameteri(this.target,10240,this._magFilter),t.texParameteri(this.target,33085,this._maxMipMapLevel),t.texParameteri(this.target,33084,this._baseMipMapLevel),t.generateMipmap(this.target)}}const u=(()=>{const t=(t,e)=>({functionName:"blendFunc"+(t.length<3?"":"Separate"),functions:t,equationName:"blendEquation"+(!e||e.length<2?"":"Separate"),equations:e||[32774]});return{createBlendMode:t,NONE:t([0,0]),NORMAL_PM:t([1,771]),ADD_PM:t([1,1]),MULTIPLY_PM:t([774,771,1,771]),SCREEN_PM:t([1,769,1,771]),ADD_NPM:t([770,1,1,1]),SRC_IN:t([772,0]),SRC_OUT:t([773,0]),SRC_ATOP:t([772,771]),DST_OVER:t([773,1]),DST_IN:t([0,770]),DST_OUT:t([0,771]),DST_ATOP:t([773,770]),XOR:t([773,771]),NORMAL:t([770,771,1,771]),ADD:t([770,772,1,772]),MULTIPLY:t([774,0]),SCREEN:t([770,769,1,769]),OVERLAY:t([1,771]),EXCLUSION:t([775,769]),LIGHTEN:t([1,1],[32776]),DARKEN:t([1,1],[32775]),SHADOW:t([774,768])}})();class l{constructor(t={}){this.contextId=0,this.isLost=e(1),this._config=a.initContextConfig(t),this._onContextLost=this._onContextLost.bind(this),this._initContext=this._initContext.bind(this);const s=this._config.canvas;this.canvas=s,s.addEventListener("webglcontextlost",this._onContextLost),s.addEventListener("webglcontextrestored",this._initContext),this._initContext()}useBlendMode(t){this._currentBlendMode=t;const e=this.gl;e[t.equationName].apply(e,t.equations),e[t.functionName].apply(e,t.functions)}setBlendMode(t,e){this._currentBlendMode!==t&&(e&&e(),this.useBlendMode(t))}destruct(){this.gl.useProgram(null);const t=this.canvas;t.removeEventListener("webglcontextlost",this._onContextLost),t.removeEventListener("webglcontextrestored",this._initContext),this._loseContext()}clearTextures(){const t=a.INFO.maxTextureImageUnits;let e=-1;for(;++e<t;)this._textureMap[e]=null,this._emptyTextureSlots[e]=e;this.textureIds.length=0}useTexture(t,e,s=!0,i){if(!t)return-1;let r=this._textureMap.indexOf(t);return r<0&&(this._emptyTextureSlots.length?r=this._emptyTextureSlots[0]:(i&&i(),this.clearTextures(),r=0),s=!0),this.useTextureAt(t,r,e,s)}useTextureAt(t,e,i,r=!0){return t.use(this.gl,e,r,i),this._textureMap[e]=t,!this.textureIds.includes(e)&&this.textureIds.push(e),s(this._emptyTextureSlots,e),e}deactivateTexture(t){const e=this._textureMap.indexOf(t);e>-1&&t.unbindTexture(this.gl,e)}useProgram(t,e){if(this._currentProgram!==t){this._currentProgram=t,this.clearTextures();const s=this.gl;s.bindVertexArray(null),s.useProgram(t),s.bindVertexArray(e)}}setCanvasSize(t,e){const s=this.canvas;s.width=t,s.height=e}setSize(t,e){if(this._width!==t||this._height!==e){this._width=t,this._height=e;const s=this.gl;s.viewport(0,0,t,e),s.scissor(0,0,t,e)}}_onContextLost(t){t.preventDefault(),setTimeout(this._restoreContext,1)}_initContext(){const s=this.gl=this.canvas.getContext("webgl2",this._config.contextAttributes);s.agl_id=++this.contextId;const i=s.getExtension("WEBGL_lose_context");i?(this._restoreContext=i.restoreContext.bind(i),this._loseContext=i.loseContext.bind(i)):this._restoreContext=this._loseContext=t,this.isLost=s.isContextLost?s.isContextLost.bind(s):e(1),s.pixelStorei(37441,!0),s.enable(3042),s.blendColor(1,1,1,1),s.enable(3089),this._width=this._height=this._currentProgram=this._currentBlendMode=null,this._textureMap=[],this._emptyTextureSlots=[],this.textureIds=[],this.clearTextures(),this.setCanvasSize(1,1),this._config.initCallback&&setTimeout(this._config.initCallback,1)}}class d{constructor(t,e,s,i,r,h,a=1){const n=s*i;this.data="number"==typeof e?new Float32Array(e*n):e,this._locationName=t,this._rows=s,this._cols=i,this._target=r??34962,this._type=h??35048,this._length=4*n,this._offset=4*i,this._divisor=a,35044===this._type&&(this._length=this._offset=0)}create(t,e){this._location=e[this._locationName],this._buffer=t.createBuffer(),this.bind(t)}bind(t){t.bindBuffer(this._target,this._buffer)}upload(t){this.bind(t),this._enable(t),t.bufferData(this._target,this.data,this._type)}destruct(){this.data=null}_enable(t){const e=this._rows,s=this._location,i=this._cols,r=this._length,h=this._offset,a=this._divisor;let n=-1;for(;++n<e;){const e=s+n;t.enableVertexAttribArray(e),t.vertexAttribPointer(e,i,5126,!1,r,n*h),t.vertexAttribDivisor(e,a)}}}const v=document.createElement("img");class p extends c{constructor(t,e){super(),this._source=v,this._parseTextureSize=this._parseTextureSize.bind(this),this.source=t,this.shouldUpdate=e,this._currentRenderTime=0}get width(){return this._sourceWidth||1}get height(){return this._sourceHeight||1}get source(){return this._source}set source(t){t&&(this._source.removeEventListener(this._eventType,this._parseTextureSize),this._source=t,this.isVideo="video"===t.tagName.toLowerCase(),this._eventType=this.isVideo?"canplay":"load",!this._parseTextureSize()&&t.addEventListener(this._eventType,this._parseTextureSize,{once:!0}))}destruct(){this._source.removeEventListener(this._eventType,this._parseTextureSize)}use(t,e,s,i){this.$currentAglId<t.agl_id?(this.$currentAglId=t.agl_id,this._baseTexture=t.createTexture(),this.useActiveTexture(t,e)):this.$updated||this._loaded||this.shouldUpdate&&this._currentRenderTime<i||this.isVideo&&!this._source.paused?(this.$updated=this._loaded=!1,this._currentRenderTime=i,this.useActiveTexture(t,e)):(this._currenActiveId!==e||s)&&this.bindActiveTexture(t,e)}get _sourceWidth(){return this._source[this._dimensionWidthName]}get _sourceHeight(){return this._source[this._dimensionHeightName]}_parseTextureSize(){if(this._dimensionWidthName="width",this._dimensionHeightName="height",this._source.naturalWidth?(this._dimensionWidthName="naturalWidth",this._dimensionHeightName="naturalHeight"):this._source.videoWidth&&(this._dimensionWidthName="videoWidth",this._dimensionHeightName="videoHeight"),this._sourceWidth*this._sourceHeight)return this.$renderSource=this._source,this._loaded=!0,!0;this.$renderSource=null}}p.loadImage=(t,e)=>{const s=document.createElement("img");return s.src=t,new p(s,e)},p.loadVideo=t=>{const e=document.createElement("video");return e.src=t,new p(e)};class g extends c{constructor(){super(),this._resized=!0}get width(){return this.$width}set width(t){this.$width!==t&&(this.$width=t,this._resized=!0)}get height(){return this.$height}set height(t){this.$height!==t&&(this.$height=t,this._resized=!0)}setSize(t,e){this.width=t,this.height=e}bind(t){t.bindFramebuffer(36160,this._framebuffer)}unbind(t){t.bindFramebuffer(36160,null)}use(t,e,s){this.$currentAglId<t.agl_id?(this.$currentAglId=t.agl_id,this._baseTexture=t.createTexture(),this.useActiveTexture(t,e),this._framebuffer=t.createFramebuffer(),this.bind(t),t.framebufferTexture2D(36160,36064,3553,this._baseTexture,0),this.unbind(t)):this.$updated?(this.$updated=!1,this.useActiveTextureAfterUpdate(t,e)):this._resized?(this._resized=!1,this.useActiveTexture(t,e)):(this._currenActiveId!==e||s)&&this.bindActiveTexture(t,e)}destruct(){}}class x{constructor(){this._updateRotationFv=t,this.cosRotationA=this.cosRotationB=1,this.sinRotationA=this.sinRotationB=this._x=this._y=this._rotation=this._anchorX=this._anchorY=this._skewX=this._skewY=0}get x(){return this._x}set x(t){this._x=t,this.$transformUpdated=!0}get y(){return this._y}set y(t){this._y=t,this.$transformUpdated=!0}get rotation(){return this._rotation}set rotation(t){this._rotation=t,this._updateRotationFv=this._updateRotation}get anchorX(){return this._anchorX}set anchorX(t){this._anchorX=t,this.$transformUpdated=!0}get anchorY(){return this._anchorY}set anchorY(t){this._anchorY=t,this.$transformUpdated=!0}get skewX(){return this._skewX}set skewX(t){this._skewX=t,this._updateRotationFv=this._updateRotation}get skewY(){return this._skewY}set skewY(t){this._skewY=t,this._updateRotationFv=this._updateRotation}update(){this._updateRotationFv(),this.updated=this.$transformUpdated,this.$transformUpdated=!1}_updateRotation(){if(this._updateRotationFv=t,this.$transformUpdated=!0,this._skewX||this._skewY){const t=this._rotation-this._skewX,e=this._rotation+this._skewY;this.sinRotationA=Math.sin(e),this.cosRotationA=Math.cos(e),this.sinRotationB=Math.sin(t),this.cosRotationB=Math.cos(t)}else this.sinRotationA=this.sinRotationB=Math.sin(this._rotation),this.cosRotationA=this.cosRotationB=Math.cos(this._rotation)}}class f extends x{constructor(){super(),this.$updateScaleFv=t,this.scaledWidth=this.scaledHeight=this._scaleX=this._scaleY=this.$width=this.$height=1}get scaleX(){return this._scaleX}set scaleX(t){this._scaleX=t,this.$updateScaleFv=this.$updateScale}get scaleY(){return this._scaleY}set scaleY(t){this._scaleY=t,this.$updateScaleFv=this.$updateScale}get width(){return this.$width}set width(t){this.$width=t,this.$updateScaleFv=this.$updateScale}get height(){return this.$height}set height(t){this.$height=t,this.$updateScaleFv=this.$updateScale}update(){this.$updateScaleFv(),super.update()}$updateScale(){this.$updateScaleFv=t,this.$transformUpdated=!0,this.scaledWidth=this.$width*this._scaleX,this.scaledHeight=this.$height*this._scaleY}}class _{constructor(){this.cache=[],this.set(1,1,1,1)}get r(){return this.cache[0]}set r(t){this.cache[0]=t,this._colorUpdated=!0}get g(){return this.cache[1]}set g(t){this.cache[1]=t,this._colorUpdated=!0}get b(){return this.cache[2]}set b(t){this.cache[2]=t,this._colorUpdated=!0}get a(){return this.cache[3]}set a(t){this.cache[3]=t,this._colorUpdated=!0}set(t,e,s,i){this.cache[0]=t,this.cache[1]=e,this.cache[2]=s,this.cache[3]=i,this._colorUpdated=!0}update(){this.updated=this._colorUpdated,this._colorUpdated=!1}}const m=()=>new Float32Array([1,0,0,1,0,0]),T=(t,e)=>{t[0]=2/e.width,t[1]=t[2]=0,t[3]=-2/e.height,t[4]=-1,t[5]=1},C=(t,e)=>{const s=e.anchorX,i=e.anchorY,r=e.scaledWidth,h=e.scaledHeight;t[0]=e.cosRotationA*r,t[1]=e.sinRotationA*r,t[2]=-e.sinRotationB*h,t[3]=e.cosRotationB*h,t[4]=e.x-s*t[0]-i*t[2],t[5]=e.y-s*t[1]-i*t[3]},y=(t,e,s)=>{const i=s.x,r=s.y,h=s.anchorX,a=s.anchorY,n=s.sinRotationA,o=s.sinRotationB,c=s.cosRotationA,u=s.cosRotationB,l=s.scaledWidth,d=s.scaledHeight;t[0]=(c*e[0]+n*e[2])*l,t[1]=(c*e[1]+n*e[3])*l,t[2]=(u*e[2]-o*e[0])*d,t[3]=(u*e[3]-o*e[1])*d,t[4]=-h*t[0]-a*t[2]+i*e[0]+r*e[2]+e[4],t[5]=-h*t[1]-a*t[3]+i*e[1]+r*e[3]+e[5]},w=(t,e)=>{const s=1/(e[0]*e[3]-e[2]*e[1]);t[0]=s*e[3],t[1]=-s*e[1],t[2]=-s*e[2],t[3]=s*e[0],t[4]=s*(e[2]*e[5]-e[3]*e[4]),t[5]=-s*(e[0]*e[5]-e[1]*e[4])},R=(t,e)=>{const s=e.x*t[0]+e.y*t[2]+t[4],i=e.x*t[1]+e.y*t[3]+t[5];return s>=0&&s<=1&&i>=0&&i<=1},$=(t,e,s)=>{const i=s.widthHalf,r=s.heightHalf;t[0].x=i+e[4]*i,t[0].y=s.height-(r+e[5]*r),t[1].x=t[0].x+(e[0]+e[2])*i,t[1].y=t[0].y-(e[1]+e[3])*r,t[2].x=t[0].x+(e[0]+i*e[2]),t[2].y=t[0].y-(e[1]+r*e[3]),t[3].x=t[0].x+(i*e[0]+e[2]),t[3].y=t[0].y-(r*e[1]+e[3])};class b{constructor(){this.RENDERING_TYPE=b.RENDERING_TYPE,this.matrixCache=m(),this.colorCache=[1,1,1,1],this.transform=new this.$transformClass,this.color=new _,this.alpha=1,this.callbackBeforeRender=this.callbackAfterRender=t,this.renderable=!0,this.$bounds={x:0,y:0,width:0,height:0}}get stage(){return this.$parent?this.$parent.stage:null}get parent(){return this.$parent}set parent(t){this.$parent=t,this._parentChanged=!0}get callbackBeforeRender(){return this._callbackBeforeRender}set callbackBeforeRender(e){this._callbackBeforeRender=e??t}get callbackAfterRender(){return this._callbackAfterRender}set callbackAfterRender(e){this._callbackAfterRender=e??t}callEventHandler(t,e){if(this.interactive){const s=this["on"+e.type];s&&s(this,t,e)}const s=this.$parent;s&&s.callEventHandler(t,e)}getBounds(){return this.$bounds}destruct(){this.remove()}remove(){const t=this.$parent;t&&t.removeChild(this)}update(){const t=this.transform,e=this.color,s=this.$parent,i=this._parentChanged;if(this._parentChanged=!1,e.update(),this.colorUpdated=i||e.updated||s.colorUpdated,this.colorUpdated){const t=this.colorCache,i=e.cache,r=s.colorCache;t[0]=r[0]*i[0],t[1]=r[1]*i[1],t[2]=r[2]*i[2],t[3]=r[3]*i[3]}t.update(),this.transformUpdated=i||t.updated||s.transformUpdated,this.transformUpdated&&y(this.matrixCache,s.matrixCache,t)}get $transformClass(){return f}}b.RENDERING_TYPE="item";class L extends b{constructor(){super(),this.$corners=[{x:0,y:0},{x:0,y:0},{x:0,y:0},{x:0,y:0}]}getCorners(){return this.$calcCorners(),this.$corners}getBounds(){const t=this.getCorners(),e=this.$bounds,s=t[0],i=t[1],r=t[2],h=t[3];return e.x=Math.min(s.x,i.x,r.x,h.x),e.y=Math.min(s.y,i.y,r.y,h.y),e.width=Math.max(s.x,i.x,r.x,h.x),e.height=Math.max(s.y,i.y,r.y,h.y),e}$calcCorners(){const t=this.stage;t&&$(this.$corners,this.matrixCache,t.renderer)}}class S extends f{constructor(){super(),this.z=0}get width(){return this.$width}set width(t){this.$width=this.$height=t,this.$updateScaleFv=this.$updateScale}get height(){return this.$height}set height(t){this.width=t}}class F extends L{constructor(){super(),this.RENDERING_TYPE=F.RENDERING_TYPE,this.castShadow=this.shading=this.centerReflection=!0,this.angle=0,this.spotAngle=180*a.THETA,this.type=F.Type.POINT,this.precision=this.shadowLength=this.specularStrength=1,this.maxShadowStep=128,this.fading=!0,this.attenuation=1}get castShadow(){return this._castShadow}set castShadow(t){this._castShadow=t,this._updateFlags()}get shading(){return this._shading}set shading(t){this._shading=t,this._updateFlags()}get flattenShadow(){return this._flattenShadow}set flattenShadow(t){this._flattenShadow=t,this._updateFlags()}get fading(){return this._fading}set fading(t){this._fading=t,this._updateFlags()}get centerReflection(){return this._centerReflection}set centerReflection(t){this._centerReflection=t,this._updateFlags()}get $transformClass(){return S}$calcCorners(){super.$calcCorners();const t=this.$corners,e=t[0],s=t[1],i=t[2],r=t[3];e.x+=e.x-r.x+(e.x-i.x),e.y+=e.y-r.y+(e.y-i.y),i.x+=i.x-s.x,i.y+=i.y-s.y,r.x+=r.x-s.x,r.y+=r.y-s.y}_updateFlags(){this.flags=this._castShadow|2*this._shading|4*this._flattenShadow|8*this._centerReflection|16*this._fading}}F.RENDERING_TYPE="light",F.Type={POINT:0,DIRECTIONAL:1};class A extends x{constructor(){super(),this.repeatRandomCache=[0,0,0,2],this._repeatX=this._repeatY=1}get scaledWidth(){return this._repeatX}get scaledHeight(){return this._repeatY}get repeatX(){return this._repeatX}set repeatX(t){this._repeatX=t,this.$transformUpdated=!0}get repeatY(){return this._repeatY}set repeatY(t){this._repeatY=t,this.$transformUpdated=!0}get repeatRandomRotation(){return this.repeatRandomCache[0]}set repeatRandomRotation(t){this.repeatRandomCache[0]=t}get repeatRandomAlpha(){return this.repeatRandomCache[1]}set repeatRandomAlpha(t){this.repeatRandomCache[1]=t}get repeatRandomBlur(){return this.repeatRandomCache[2]}set repeatRandomBlur(t){this.repeatRandomCache[2]=t}get repeatRandomOffset(){return this.repeatRandomCache[3]}set repeatRandomOffset(t){this.repeatRandomCache[3]=t}}class E{constructor(){this.cache=[0,0,1,1],this._updateCacheFv=this._updateCache,this._width=this._height=1}get x(){return this.cache[0]}set x(t){this.cache[0]=t,this._updateCacheFv=this._updateCache}get y(){return this.cache[1]}set y(t){this.cache[1]=t,this._updateCacheFv=this._updateCache}get width(){return this._width}set width(t){this._width=t,this._updateCacheFv=this._updateCache}get height(){return this._height}set height(t){this._height=t,this._updateCacheFv=this._updateCache}setRect(t){this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height}update(){this._updateCacheFv(),this.updated=this._cacheUpdated,this._cacheUpdated=!1}_updateCache(){this._updateCacheFv=t,this._cacheUpdated=!0,this.cache[2]=this._width-this.cache[0],this.cache[3]=this._height-this.cache[1]}}class M{constructor(){this.distortTexture=!0,this.cache=[0,0,1,0,1,1,0,1]}get topLeftX(){return this.cache[0]}set topLeftX(t){this.cache[0]=t}get topLeftY(){return this.cache[1]}set topLeftY(t){this.cache[1]=t}get topRightX(){return this.cache[2]}set topRightX(t){this.cache[2]=t}get topRightY(){return this.cache[3]}set topRightY(t){this.cache[3]=t}get bottomRightX(){return this.cache[4]}set bottomRightX(t){this.cache[4]=t}get bottomRightY(){return this.cache[5]}set bottomRightY(t){this.cache[5]=t}get bottomLeftX(){return this.cache[6]}set bottomLeftX(t){this.cache[6]=t}get bottomLeftY(){return this.cache[7]}set bottomLeftY(t){this.cache[7]=t}}class P extends L{constructor(t){super(),this.RENDERING_TYPE=P.RENDERING_TYPE,this.texture=t,this.tintType=P.TintType.NORMAL,this.blendMode=u.NORMAL,this._inverseMatrixCache=new Float32Array(6),this.textureMatrixCache=m(),this.textureTransform=new A,this.textureCrop=new E,this.distortionProps=new M,this.textureCropCache=this.textureCrop.cache,this.textureRepeatRandomCache=this.textureTransform.repeatRandomCache,this.distortionPropsCache=this.distortionProps.cache}update(){super.update(),this.textureCrop.update();const t=this.textureTransform;t.update(),t.updated&&C(this.textureMatrixCache,t),this.interactive&&this.transformUpdated&&w(this._inverseMatrixCache,this.matrixCache)}isContainsPoint(t){return R(this._inverseMatrixCache,t)}}P.RENDERING_TYPE="drawable",P.TintType={NONE:0,NORMAL:1,GRAYSCALE:2,OVERRIDE:3,ADD:4};class I extends b{constructor(){super(),this.RENDERING_TYPE=I.RENDERING_TYPE,this.children=[],this.useTint=!0}get parent(){return this.$parent}set parent(t){super.parent=t,t?(this._getParentPremultipliedUseTint=t.getPremultipliedUseTint.bind(t),this._getParentPremultipliedAlpha=t.getPremultipliedAlpha.bind(t)):this._getParentPremultipliedUseTint=this._getParentPremultipliedAlpha=e(1)}getPremultipliedUseTint(){return this.useTint*this._getParentPremultipliedUseTint()}getPremultipliedAlpha(){return this.alpha*this._getParentPremultipliedAlpha()}destruct(){this.empty(),super.destruct()}empty(){for(;this.children.length;)this.removeChildAt(0)}contains(t){return this.getChildIndex(t)>-1}addChild(t){this.addChildAt(t,this.children.length)}addChildAt(t,e){t&&(t.remove(),this.children.push(t),this.setChildIndex(t,e),t.parent=this)}removeChild(t){t&&(s(this.children,t),t.parent=null)}removeChildAt(t){this.removeChild(this.getChildAt(t))}getChildAt(t){return this.children[t]}setChildIndex(t,e){s(this.children,t),this.children.splice(e,0,t)}getChildIndex(t){return this.children.indexOf(t)}swapChildren(t,e){const s=this.getChildIndex(t),i=this.getChildIndex(e);s>-1&&i>-1&&(this.setChildIndex(t,i),this.setChildIndex(e,s))}getBounds(){const t=this.$bounds,e=this.children,s=e.length;let i=-1;for(t.x=t.y=1/0,t.width=t.height=-1/0;++i<s;){const s=e[i].getBounds();t.x=Math.min(t.x,s.x),t.y=Math.min(t.y,s.y),t.width=Math.max(t.width,s.width),t.height=Math.max(t.height,s.height)}return t}}I.RENDERING_TYPE="container";class N{constructor(e){this._clearBeforeRenderFunc=t,this._resizeCalcFv=t,this._rendererId=1,this.width=this.height=this.widthHalf=this.heightHalf=this._currentContextId=this._currentRendererId=this.$renderTime=0,this.setSize(1,1),this.clearColor=new _,this._config=e,this.context=e.context,a.setLocations(e,["uFY","aPs","uTx"]),this._elementArrayBuffer=new d("",new Uint16Array([0,1,3,2]),0,0,34963,35044),this._positionBuffer=new d("aPs",new Float32Array([0,0,1,0,1,1,0,1]),1,2,34962,35044,0)}set clearBeforeRender(e){this._clearBeforeRenderFunc=e?this._clear:t}setSize(t,e){this.width=t,this.height=e,this._resizeCalcFv=this.$resize}renderToFramebuffer(t){this.context.isLost()||(this._switchToProgram(),this.$attachFramebufferAndClear(t),this._renderBatch(t),t.unbind(this.$gl))}render(){this.context.isLost()||(this._switchToProgram(),this.$gl.uniform1f(this.$locations.uFY,1),this._clearBeforeRenderFunc(),this._renderBatch())}destruct(){}$attachFramebuffer(t){t.bind(this.$gl),t.setSize(this.width,this.height),this.context.useTexture(t,this.$renderTime,!1),this.context.deactivateTexture(t),this.$gl.uniform1f(this.$locations.uFY,-1)}$attachFramebufferAndClear(t){this.$attachFramebuffer(t),this._clearBeforeRenderFunc()}$drawInstanced(t){this.$gl.drawElementsInstanced(5,4,5123,0,t)}$useTextureAt(t,e,s,i){this.$gl.uniform1i(e,this.context.useTextureAt(t,s,this.$renderTime,i))}$useTexture(t,e,s){this.$gl.uniform1i(e,this.context.useTexture(t,this.$renderTime,s))}$uploadBuffers(){const t=this.$gl;this._positionBuffer.upload(t),this._elementArrayBuffer.upload(t)}$createBuffers(){const t=this.$gl,e=this.$locations;this._elementArrayBuffer.create(t,e),this._positionBuffer.create(t,e)}$resize(){this.resized=!0,this._resizeCalcFv=t,this.widthHalf=this.width/2,this.heightHalf=this.height/2}_renderBatch(t){this.$renderTime=Date.now(),this.$render(t)}_switchToProgram(){this.$gl=this.context.gl;const t=this.context.contextId;this._currentContextId!==t||this._currentRendererId!==this._rendererId?(this._currentContextId=t,this._currentRendererId=this._rendererId,this._buildProgram()):this._useProgram(),this.resized=!1,this._resizeCalcFv(),this.context.setSize(this.width,this.height)}_clear(){this.$gl;const t=this.clearColor;this.$gl.clearColor(t.r,t.g,t.b,t.a),this.$gl.clear(16384)}_buildProgram(){const t=this.$gl,e=a.GLSL.VERSION+"precision highp float;\n";this._program=a.createProgram(t,e+this.$createVertexShader(),e+this.$createFragmentShader()),this.$locations=a.getLocationsFor(t,this._program,this._config.locations),this._vao=t.createVertexArray(),this._useProgram(),this.$createBuffers()}_useProgram(){this.context.useProgram(this._program,this._vao)}}class D extends N{constructor(t){a.setLocations(t,["aMt"]),super(t),this.$MAX_RENDER_COUNT=t.maxRenderCount||1e4,this.$matrixBuffer=new d("aMt",this.$MAX_RENDER_COUNT,4,4)}$uploadBuffers(){this.$matrixBuffer.upload(this.$gl),super.$uploadBuffers()}$createBuffers(){super.$createBuffers(),this.$matrixBuffer.create(this.$gl,this.$locations)}}const B="vec4 pos=vec4(aPs*2.-1.,1,1);gl_Position=pos;gl_Position.y*=uFY;",z="vec2(aPs.x,1.-aPs.y)",G="in vec2 aPs;",U="uniform float uFY;",Y=G+U;const k=(t,e,s=0)=>{let i=e.length;for(;--i>-1;)t[s+i]=e[i];return t};class H extends I{constructor(t){super(),this.renderer=t,this.colorCache=this.color.cache,delete this.parent,delete this.transform}get stage(){return this}getPremultipliedUseTint(){return this.useTint}getPremultipliedAlpha(){return this.alpha}update(){const t=this.color,e=this.renderer;t.update(),this.colorUpdated=t.updated,this.transformUpdated=e.resized,this.transformUpdated&&T(this.matrixCache,e)}}const O="_draw",X="mousemove",Z="mousedown",V="mouseup",W="click",q="touchstart",K="touchmove",j="touchend",Q="PointerDown",J="PointerMove",tt="PointerUp",et=[X,Z,V,W,q,K,j],st={[W]:"PointerClick",[Z]:Q,[q]:Q,[X]:J,[K]:J,[V]:tt,[j]:tt};class it{constructor(t=0){this.on=!0,this.v=new Float32Array(9),this.intensity=t}get intensity(){return this.v[0]}set intensity(t){this.v[0]=t}get intensityX(){return this.v[0]}set intensityX(t){this.v[0]=t}get intensityY(){return this.v[1]}set intensityY(t){this.v[1]=t}get mix(){return this.v[1]}set mix(t){this.v[1]=t}get r(){return this.v[2]}set r(t){this.v[2]=t}get g(){return this.v[3]}set g(t){this.v[3]=t}get b(){return this.v[4]}set b(t){this.v[4]=t}}class rt extends it{constructor(t,e=1){super(t),this.mix=e}get GLSL(){return"kr*=v;oCl.rgb=(oCl.rgb*(1.-vl[1]))+(texelFetch(uTx,f-ivec2(1),0)*kr[0].x+texelFetch(uTx,f+ivec2(0,-1),0)*kr[0].y+texelFetch(uTx,f+ivec2(1,-1),0)*kr[0].z+texelFetch(uTx,f+ivec2(-1,0),0)*kr[0].w+oCl*kr[1].x+texelFetch(uTx,f+ivec2(1,0),0)*kr[1].y+texelFetch(uTx,f+ivec2(-1,1),0)*kr[1].z+texelFetch(uTx,f+ivec2(0,1),0)*kr[1].w+texelFetch(uTx,f+ivec2(1),0)*kr[2].x).rgb*vl[1];"}get kernels(){return this._kernels}set kernels(t){this._kernels=k(this._kernels??new Float32Array(16),t)}}class ht extends it{constructor(t,e,s=!1,i=.5,r=.5,h=1){super(t),this.intensityY=e,this.isRadial=s,this.centerX=i,this.centerY=r,this.size=h}get isRadial(){return this.v[2]}set isRadial(t){this.v[2]=t?1:0}get centerX(){return this.v[3]}set centerX(t){this.v[3]=t}get centerY(){return this.v[4]}set centerY(t){this.v[4]=t}get size(){return this.v[5]}set size(t){this.v[5]=t}}ht.$createGLSL=(t,e,s="")=>"vec2 wh=vec2(v,vl[1]);float lngWH=length(wh/ts);if(lngWH>0.){float rd=rand(v0.zw),rd2=.5+rand(v0.zw)*.5,cnt=1.,l=4.+ceil(4.*rd),t=RADIANS_360/l;vec2 ps,dr=Z.yx,r=vec2(cos(t),sin(t));vec4 clg,cl=oCl;ivec2 mn=ivec2(Z.xx),mx=ivec2(ts)-1;mat2 rot=mat2(r.x,-r.y,r.y,r.x);"+t+"for(float i=0.;i<l;i++){ps=wh*rd2*round(dr);clg=texelFetch(uTx,clamp(f+ivec2(ps),mn,mx),0);dr*=rot;"+e+"}"+s+"cl/=cnt;float dst=mix(1.,clamp(distance(vec2(vl[3],vl[4]),v0.zw)*vl[5],0.,1.),vl[2]);oCl=dst*cl+(1.-dst)*oCl;}";class at{constructor(t,e,s=0,i=0,r=0,h=0,a=1,n=1){this._filter=t,this.texture=e,this.translateX=s,this.translateY=i,this.cropX=r,this.cropY=h,this.cropWidth=a,this.cropHeight=n}get translateX(){return this._filter.v[1]}set translateX(t){this._filter.v[1]=t}get translateY(){return this._filter.v[2]}set translateY(t){this._filter.v[2]=t}get cropX(){return this._filter.v[3]}set cropX(t){this._filter.v[3]=t}get cropY(){return this._filter.v[4]}set cropY(t){this._filter.v[4]=t}get cropWidth(){return this._filter.v[5]}set cropWidth(t){this._filter.v[5]=t}get cropHeight(){return this._filter.v[6]}set cropHeight(t){this._filter.v[6]=t}}class nt extends it{constructor(t,e,s,i,r,h,a,n){super(e),this.textureTransform=new at(this,t,s,i,r,h,a,n)}}nt.$createGLSL=t=>"vec4 mskCl=texture(uFTx,mod(vec2(vl[1],vl[2])+v0.zw,1.)*vec2(vl[5]-vl[3],vl[6]-vl[4]));"+t;const ot=nt.$createGLSL("oCl=texture(uTx,v0.zw+(Z.yz*(mskCl.rg-.5)*2.*vol));");const ct=nt.$createGLSL("oCl.a*=v<4.?mskCl[int(v)]:(mskCl.r+mskCl.g+mskCl.b+mskCl.a)/4.;");class ut extends nt{get GLSL(){return ct}get type(){return this.v[0]}set type(t){this.v[0]=t}}ut.Type={RED:0,GREEN:1,BLUE:2,ALPHA:3,AVG:4};const lt=ht.$createGLSL("","cl+=clg;cnt++;");const dt=ht.$createGLSL("float clgRl,bst=1.,oClRl=rl(oCl.rgb);","clgRl=rl(clg.rgb);bst+=max(0.,(clgRl-oClRl)/length(ps));","cl*=bst+(bst>1.?lngWH:0.);");window.PWGL=window.AGL={version:"5.0.7",BlendMode:u,Texture:p,Framebuffer:g,Context:l,Buffer:d,Utils:a,Const:n,Item:b,BaseDrawable:L,Light:F,AnimatedImage:class extends P{constructor(t){super(t),this._frame=0,this.frameLength=this._currentFrameLength=120,this._frames=[],this._currentRenderTime=Date.now(),this.stop()}get frames(){return this._frames}set frames(t){this._frames=t;const e=this._frames[0];e&&(this._currentFrameLength=e.length??this.frameLength,this._currentRenderTime=Date.now())}gotoAndStop(t){this.stop(),this._frame=t,this._useTextureFrame()}gotoAndPlay(t){this._frame=t,this.play()}stop(){this._updateAnimationFv=t,this.isPlaying=!1}play(){this._updateAnimationFv=this._updateAnimation,this.isPlaying=!0,this._useTextureFrame()}update(t){super.update(),this._updateAnimationFv(t)}destruct(){this.stop(),super.destruct()}_updateAnimation(t){const e=t-this._currentRenderTime;e>this._currentFrameLength&&(this._currentRenderTime=t,this._frame+=~~(e/this._currentFrameLength),this._frame>=this._frames.length&&(this._frame=0),this._useTextureFrame())}_useTextureFrame(){const t=this._frames[this._frame];this.textureCrop.setRect(t),this._currentFrameLength=t.length??this.frameLength}},Container:I,Image:P,BaseRenderer:N,BatchRenderer:D,FilterRenderer:class extends N{constructor(e={}){e=a.initRendererConfig(e),a.setLocations(e,["uFTx","uId","uFV","uFK","uRT"]),super(e),this._attachFramebufferAndClearFv=this.$attachFramebufferAndClear,this.$attachFramebufferAndClear=t,this.filters=e.filters||[],this.sourceTexture=e.sourceTexture,this._framebuffers=[new g,new g]}get filters(){return this._filters}set filters(t){this._filters=new Proxy(t,{deleteProperty:(t,e)=>(delete t[e],this._rendererId++,!0),set:(t,e,s)=>(t[e]=s,this._rendererId++,!0)}),this._rendererId++}$render(t){const e=this.context,s=this.$gl,i=this.$renderTime,r=this.$locations,h=this._filters,a=h.length||1,n=a-2;let o=-1;for(e.setBlendMode(u.NORMAL),this.$uploadBuffers(),s.uniform1f(r.uRT,i%864e5),this.$useTextureAt(this.sourceTexture,r.uTx,0);++o<a;){const a=h[o],c=a&&a.on,u=o>n,l=c&&a.textureTransform&&a.textureTransform.texture;let d;l&&this.$useTextureAt(l,r.uFTx,1),u?t?this._attachFramebufferAndClearFv(t):s.uniform1f(r.uFY,1):c&&(d=this._framebuffers[1&o],this._attachFramebufferAndClearFv(d)),c&&(s.uniform1i(r.uId,a.uniqueId),s.uniform1fv(r.uFV,a.v),a.kernels&&s.uniformMatrix4fv(r.uFK,!1,a.kernels)),(c||u)&&this.$drawInstanced(1),l&&e.deactivateTexture(l),d&&(d.unbind(s),e.useTextureAt(d,0,i))}}$createVertexShader(){return Y+"out vec4 v0;void main(void){"+B+"v0=vec4(pos.xy,"+z+");}"}$createFragmentShader(){return a.GLSL.DEFINE.Z+a.GLSL.DEFINE.RADIANS_360+"in vec4 v0;uniform int uId;uniform float uRT,uFV[9];uniform mat4 uFK;uniform sampler2D uTx,uFTx;out vec4 oCl;"+a.GLSL.RANDOM+"float tl(float c){return c<=.04045?c/12.92:pow((c+.055)/1.055,2.4);}float rl(vec3 c){return .2126*tl(c.r)+.7152*tl(c.g)+.0722*tl(c.b);}float gtGS(vec3 cl){return .3*cl.r+.59*cl.g+.11*cl.b;}void main(void){oCl=texture(uTx,v0.zw);float vl[]=uFV,v=vl[0];vec2 ts=vec2(textureSize(uTx,0));ivec2 f=ivec2(floor(v0.zw*ts));vec2 vol=v/ts;vec3 rgb=vec3(vl[2],vl[3],vl[4]);vec4 oClVl=oCl*(1.-v);mat4 kr=uFK;"+this.filters.reduce((t,e)=>{let s=t.findIndex(t=>t.GLSL===e.GLSL);return s<0&&(s=t.push(e)-1),e.uniqueId=s,t},[]).map(t=>"if(uId=="+t.uniqueId+"){"+t.GLSL+"}").join("else ")+"}"}},NormalMapRenderer:class extends N{constructor(t={}){super(t=a.initRendererConfig(t)),this.heightMap=t.heightMap}$render(){this.context.setBlendMode(u.NORMAL),this.$useTextureAt(this.heightMap,this.$locations.uTx,0),this.$uploadBuffers(),this.$drawInstanced(1)}$createVertexShader(){return Y+"uniform sampler2D uTx;out vec2 v0;void main(void){"+B+"v0="+z+";}"}$createFragmentShader(){return a.GLSL.DEFINE.Z+a.GLSL.DEFINE.HEIGHT+"in vec2 v0;uniform sampler2D uTx;out vec4 oCl;void main(void){vec2 ts=vec2(textureSize(uTx,0)),p=1./ts,p0=floor(v0.xy*ts),p1=p0+Z.yx,p2=p0+Z.yy;vec3 A=vec3(p0,texture(uTx,p0*p).g),B=vec3(p1,texture(uTx,p1*p).g),C=vec3(p2,texture(uTx,p2*p).g),nm=normalize(cross(B-A,C-A))*HEIGHT*Z.yzy;oCl=vec4(nm*.5+.5,1);}"}},AmbientOcclusionMapRenderer:class extends N{constructor(t={}){t=a.initRendererConfig(t),a.setLocations(t,["uSTx","uP","uUST","uOs"]),super(t),this.sourceTexture=t.sourceTexture,this.heightMap=t.heightMap,this.radius=t.radius??4,this.samples=t.samples??4,this.multiplier=t.multiplier??1,this.depthMultiplier=t.depthMultiplier??1,this._offset=t.offset??new Float32Array(2)}get offsetX(){return this._offset[0]}set offsetX(t){this._offset[0]=t}get offsetY(){return this._offset[1]}set offsetY(t){this._offset[1]=t}setOffset(t,e){this._offset[0]=t,this._offset[1]=e}$render(){const t=this.$gl,e=this.$locations,s=!!this.sourceTexture;this.context.setBlendMode(u.NORMAL),this.$useTextureAt(this.heightMap,e.uTx,0),s&&this.$useTextureAt(this.sourceTexture,e.uSTx,1),t.uniform1f(e.uUST,s),t.uniform4f(e.uP,this.radius,this.samples,this.multiplier,this.depthMultiplier),t.uniform2fv(e.uOs,this._offset),this.$uploadBuffers(),this.$drawInstanced(1)}$createVertexShader(){return a.GLSL.DEFINE.RADIANS_360+Y+"uniform vec4 uP;out vec4 v0;void main(void){"+B+"float r=RADIANS_360/uP.y;v0=vec4("+z+",vec2(cos(r),sin(r)));}"}$createFragmentShader(){return a.GLSL.DEFINE.Z+"in vec4 v0;uniform sampler2D uSTx,uTx;uniform float uUST;uniform vec2 uOs;uniform vec4 uP;out vec4 oCl;"+a.GLSL.RANDOM+"void main(void){vec2 vxy=v0.xy,ts=1./vec2(textureSize(uTx,0));float tx=texture(uTx,vxy).g,v=0.;if(uP.y>0.&&uP.x>0.){vec2 rg;float rnd=rand(vxy+uOs*ts)*.9+.1,l=min(uP.y,1024.);vec2 n=(uP.x*ts)*rnd,dr=Z.yx;float ln=length(n);mat2 rot=mat2(v0.z,-v0.w,v0.w,v0.z);for(float i=0.;i<l;i++){rg=max(texture(uTx,vxy+dr*n).rg-tx,Z.xx);v+=(rg.y*(1.-rg.y))/(1.+ln*uP.x);dr*=rot;}v/=l;}vec3 stCl=uUST>0.?texture(uSTx,vxy).rgb:Z.yyy;oCl=vec4(stCl*(mix(1.,tx,uP.w)-v*uP.z),1);}"}},LightRenderer:class extends D{constructor(t={}){t=a.initRendererConfig(t),a.setLocations(t,["aExt","uNTx","uSTx","uRTx","uTS","uUT"]),super(t),this.clearBeforeRender=!0,this.clearColor.set(0,0,0,1),this._sizable=this,this.sourceTexture=t.sourceTexture,this.normalMap=t.normalMap,this.heightMap=t.heightMap,this.roughnessMap=t.roughnessMap,this._extensionBuffer=new d("aExt",this.$MAX_RENDER_COUNT,2,3)}get sourceTexture(){return this._sourceTexture}set sourceTexture(t){this._sourceTexture=t,t&&(this._sizable=t)}get normalMap(){return this._normalMap}set normalMap(t){this._normalMap=t,t&&(this._sizable=t)}get heightMap(){return this._heightMap}set heightMap(t){this._heightMap=t,t&&(this._sizable=t)}get roughnessMap(){return this._roughnessMap}set roughnessMap(t){this._roughnessMap=t,t&&(this._sizable=t)}addLightForRender(t){const e=this._batchItems,s=t.parent;if(e<this.$MAX_RENDER_COUNT&&s){const i=16*e,r=6*e,h=this.$matrixBuffer.data,a=this._extensionBuffer.data;k(h,t.matrixCache,i),h[i+6]=t.transform.width,h[i+7]=t.spotAngle,k(h,t.colorCache,i+8),h[i+12]=t.shadowLength,h[i+13]=t.alpha*s.getPremultipliedAlpha(),h[i+14]=t.angle,h[i+15]=t.type,a[r]=t.flags,a[r+1]=t.transform.z,a[r+2]=t.precision,a[r+3]=t.maxShadowStep,a[r+4]=t.specularStrength,a[r+5]=t.attenuation,++this._batchItems}}$render(){const t=this.$gl,e=this.$locations,s=!!this.sourceTexture,i=!!this.normalMap,r=!!this.roughnessMap,h=!!this.heightMap;this.context.setBlendMode(u.ADD),s&&this.$useTexture(this._sourceTexture,e.uSTx),i&&this.$useTexture(this._normalMap,e.uNTx),r&&this.$useTexture(this._roughnessMap,e.uRTx),h&&this.$useTexture(this._heightMap,e.uTx),t.uniform3f(e.uUT,s,r,i),t.uniform2f(e.uTS,this._sizable.width,this._sizable.height),this.$uploadBuffers(),this.$drawInstanced(this._batchItems),this._batchItems=0}$uploadBuffers(){this._extensionBuffer.upload(this.$gl),super.$uploadBuffers()}$createBuffers(){super.$createBuffers(),this._extensionBuffer.create(this.$gl,this.$locations)}$createVertexShader(){return a.GLSL.DEFINE.Z+a.GLSL.DEFINE.PI+"#define P vec4(1,-1,2,-2)\n"+G+"in mat4 aMt;in mat2x3 aExt;"+U+"out vec2 v0;out vec4 v1,v2,v3,v4,v5;void main(void){vec3 pos=vec3(aPs*2.-1.,1);v2=vec4(aMt[3].w,aExt[0]);v1=vec4(aExt[1],PI-aMt[1].w);v5=aMt[2];v5.a*=aMt[3].y;v4.xy=pos.xy;mat3 mt=mat3(aMt[0].xy,0,aMt[0].zw,0,aMt[1].xy,1);v0.x=aMt[1].z;v0.y=v0.x*aMt[3].x;if(v2.x<1.){gl_Position=vec4(mt*pos,1);v3.xy=(gl_Position.xy+P.xy)/P.zw;v4.zw=(aMt[1].xy+P.xy)/P.zw;float amtz=aMt[3].z;v3.zw=vec2(sin(amtz),cos(amtz));}else{mt[2].xy=Z.zy;gl_Position=vec4(pos,1);v3.xy=(gl_Position.xy+P.xy)/P.zw;v4.zw=v3.xy+((mt*vec3(1)).xy+P.xy)/P.zw;}gl_Position.y*=uFY;}"}$createFragmentShader(){const t=t=>"for(i=m;i<l;i+=st){p=ivec2((v4.zw+i*opdm)*uTS);tc=texelFetch(uTx,p,0)*HEIGHT;"+t+"}";return a.GLSL.DEFINE.HEIGHT+a.GLSL.DEFINE.Z+"in vec2 v0;in vec4 v1,v2,v3,v4,v5;uniform vec2 uTS;uniform vec3 uUT;uniform sampler2D uNTx,uSTx,uRTx,uTx;out vec4 oCl;"+a.GLSL.RANDOM+"void main(void){float vol=v5.a;if(vol<=0.)discard;vec2 p2xy=v3.xy,tUv=p2xy*uTS,tCnt=v4.zw*uTS;vec4 tc=texelFetch(uTx,ivec2(tUv),0);int flg=int(v2.y);float ph=tc.g*HEIGHT,spc=0.;vec3 sf=vec3(tUv,ph),lp=vec3(tCnt,v2.z),sftla=lp-sf;if(v2.x<1.){float d=length(sftla)/v0.x,od=1.-d,dv=(flg&16)>0?pow(od,v1.z):1.;vol*=dv;float slh=(v2.z-ph)/HEIGHT;vec2 sl=vec2(slh*v3.w-v4.x*v3.z,slh*v3.z+v4.x*v3.w);if(vol<=0.||od<=0.||atan(sl.x,length(vec2(sl.y,v4.y)))+"+a.ALPHA+"-v1.w<0.)discard;}float fltDst=distance(tCnt,tUv),shdw=1.;if((flg&2)>0){vec3 nm=uUT.z>0.?normalize((texture(uNTx,p2xy).rgb*2.-1.)*Z.yzy):Z.xxy,sftl=normalize(sftla),sftv=normalize(vec3((flg&8)>0?uTS*.5:tUv,HEIGHT)-sf),hlf=normalize(sftl+sftv);vol*=dot(nm,sftl);if(vol<=0.)discard;float rgh=1.,shn=uUT.y>0.?texture(uRTx,p2xy).r:tc.b;spc=pow(max(dot(nm,hlf),0.),32.)*shn*v1.y;}if((flg&1)>0){ivec2 p;vec2 opd=(tUv-tCnt)/fltDst,opdm=opd/uTS;float st=max(1.,ceil(fltDst/v1.x)),i,pc,l=min(fltDst-st,4096.),m=max(st,l-v0.y);if((flg&4)>0)"+t("if(tc.g>=v2.z)discard;")+"else{float opdL=length(opd),hst=(ph-v2.z)/fltDst,rnd=v2.w*rand(p2xy);"+t("st+=rnd;pc=v2.z+i*hst;shdw*=mix(1.,(fltDst-i*opdL)/v0.y,step(tc.r,pc)*step(pc,tc.g));")+"}}vec3 stCl=uUT.x>0.?texture(uSTx,p2xy).rgb:Z.yyy;oCl=vec4((stCl+spc)*v5.rgb*vol*shdw,1);}"}},Stage2D:class extends D{constructor(e={}){(e=a.initRendererConfig(e)).useTint=e.useTint??!0,a.setLocations(e,["aDt","aDst"]),super(e);const s=this.$MAX_RENDER_COUNT;this.container=new H(this),this._batchItems=0,this[O+b.RENDERING_TYPE]=this[O+F.RENDERING_TYPE]=t,this[O+P.RENDERING_TYPE]=this._drawImage,this[O+I.RENDERING_TYPE]=this._drawContainer,this._batchDraw=this._batchDraw.bind(this),this._mousePosition={x:0,y:0},this._dataBuffer=new d("aDt",s,3,4),this._distortionBuffer=new d("aDst",s,4,2),this._onMouseEventHandler=this._onMouseEventHandler.bind(this);const i=this.context.canvas,r=e.lightRenderer;et.forEach(t=>i.addEventListener(t,this._onMouseEventHandler)),r&&this.attachLightRenderer(r)}attachLightRenderer(t){this[O+F.RENDERING_TYPE]=t.addLightForRender.bind(t)}detachLightRenderer(){this[O+F.RENDERING_TYPE]=t}destruct(){const t=this.context.canvas;et.forEach(e=>t.removeEventListener(e,this._onMouseEventHandler))}_handleMouseEvent(){const t=this._latestEvent,e=this._eventTarget,s=this._previousEventTarget;if(t){if(e!==s){const i={...t};s&&s.callEventHandler(s,{...i,type:"PointerOut"}),e&&e.callEventHandler(e,{...i,type:"PointerOver"})}e&&e.callEventHandler(e,{...t,type:st[t.type]}),this._previousEventTarget=e}this._latestEvent=null}_setMousePosition(t,e){this._isMousePositionSet=!0;const s=this.container.matrixCache,i=this._mousePosition;i.x=(t-this.widthHalf)*s[0],i.y=(e-this.heightHalf)*s[3]}_drawItem(t){const e=this.$renderTime;t.update(e),t.callbackBeforeRender(t,e),t.renderable&&this[O+t.RENDERING_TYPE](t),t.callbackAfterRender(t,e)}_drawContainer(t){const e=t.children,s=e.length;let i=-1;for(;++i<s;)this._drawItem(e[i])}_drawImage(t){this.context.setBlendMode(t.blendMode,this._batchDraw);const e=this._batchItems,s=12*e,i=16*e,r=t.parent,h=this._dataBuffer.data,a=this.$matrixBuffer.data;r&&(this._isMousePositionSet&&t.interactive&&t.isContainsPoint(this._mousePosition)&&(this._eventTarget=t),k(h,t.colorCache,s),k(h,t.textureRepeatRandomCache,s+8),h[s+4]=t.alpha*r.getPremultipliedAlpha(),h[s+5]=t.tintType*r.getPremultipliedUseTint(),h[s+6]=this.context.useTexture(t.texture,this.$renderTime,!1,this._batchDraw),h[s+7]=t.distortionProps.distortTexture,k(a,t.matrixCache,i),k(a,t.textureMatrixCache,i+6),k(a,t.textureCropCache,i+12),k(this._distortionBuffer.data,t.distortionPropsCache,8*e),++this._batchItems===this.$MAX_RENDER_COUNT&&this._batchDraw())}_batchDraw(){this._batchItems&&(this.$uploadBuffers(),this.$gl.uniform1iv(this.$locations.uTx,this.context.textureIds),this.$drawInstanced(this._batchItems),this._batchItems=0)}_onMouseEventHandler(t){this._latestEvent=t;const e=this.context.canvas;this._setMousePosition(e.width/e.offsetWidth*t.offsetX,e.height/e.offsetHeight*t.offsetY)}$render(){this._eventTarget=null,this._drawItem(this.container),this._batchDraw(),this._isMousePositionSet=!1,this._handleMouseEvent()}$uploadBuffers(){const t=this.$gl;this._dataBuffer.upload(t),this._distortionBuffer.upload(t),super.$uploadBuffers()}$createBuffers(){const t=this.$gl,e=this.$locations;super.$createBuffers(),this._dataBuffer.create(t,e),this._distortionBuffer.create(t,e)}$createVertexShader(){const t=this._config.useRepeatTextures,e=a.INFO.maxTextureImageUnits;return a.GLSL.DEFINE.Z+G+"in mat4x2 aDst;in mat3x4 aDt;in mat4 aMt;"+U+"uniform sampler2D uTx["+e+"];out vec3 v0;out vec4 v1,v2,v3"+(t?",v4;":";")+"vec2 gtTexS(float i){"+Array(e).fill().map((t,e)=>"if(i<"+(e+1)+".)return .5/vec2(textureSize(uTx["+e+"],0));").join("")+"return Z.yy;}vec2 clcQd(vec2 p){return mix(mix(aDst[0],aDst[1],p.x),mix(aDst[3],aDst[2],p.x),p.y);}void main(void){vec2 tPs=clcQd(aPs);gl_Position=vec4(mat3(aMt[0].xy,0,aMt[0].zw,0,aMt[1].xy,1)*vec3(tPs,1.),1)*vec4(1.,uFY,1.,1.);v0=aDt[1].xyz;v1=vec4((mat3(aMt[1].zw,0,aMt[2].xy,0,aMt[2].zw,1)*vec3(mix(tPs,aPs,aDt[1].w),1.)).xy,gtTexS(v0.z));v2=aMt[3];v3=aDt[0];"+(t?"v4=aDt[2];":"")+"}"}$createFragmentShader(){const t=this._config,e=a.INFO.maxTextureImageUnits,s=t.useRepeatTextures,i=t.useTint,r=t=>"gtTexCl(v0.z,v2,"+t+")";return a.GLSL.DEFINE.Z+a.GLSL.DEFINE.RADIANS_360+"in vec3 v0;in vec4 v1,v2,v3"+(s?",v4;":";")+"uniform sampler2D uTx["+e+"];out vec4 oCl;vec4 gtTexCl(float i,vec4 s,vec2 m){vec2 sxy=s.xy,szw=s.zw,ofs=szw*m,vpzw=v1.zw,cp=clamp(sxy+ofs,sxy+vpzw,sxy+szw-vpzw);"+Array(e).fill().map((t,e)=>"if(i<"+(e+1)+".)return texture(uTx["+e+"],cp);").join("")+"return Z.yyyy;}float cosine(float a,float b,float v){v=abs(v);float t=-2.*v+2.;v=mix(2.*v*v,1.-t*t*.5,step(.5,v));return a*(1.-v)+b*v;}"+(s?a.GLSL.RANDOM2+"vec4 gtClBUv(vec2 st){vec2 uv=v1.xy;float rnd=rand2(floor(uv+st)/100.),rndDg=rnd*RADIANS_360*v4.x;if(rndDg>0.){vec2 rt=vec2(sin(rndDg),cos(rndDg));uv=vec2(uv.x*rt.y-uv.y*rt.x,uv.x*rt.x+uv.y*rt.y);}return "+r("mod(uv,Z.yy)")+";}float gtRClBUv(vec2 st,vec2 uv){float rnd=rand2(floor(v1.xy+st)/100.);return (1.-(v4.w*rnd-v4.w*.5)*v4.y)*cosine(0.,1.,1.-st.x-uv.x)*cosine(0.,1.,1.-st.y-uv.y);}":"")+"void main(void){if(v0.z>-1.){vec2 uv=mod(v1.xy,Z.yy);"+(s?"if(v4.x>0.||v4.y>0.){vec4 rc=vec4(gtRClBUv(Z.xx,uv),gtRClBUv(Z.yx,uv),gtRClBUv(Z.xy,uv),gtRClBUv(Z.yy,uv));oCl=mix(gtClBUv(Z.xy),clamp(gtClBUv(Z.xx)*rc.x+gtClBUv(Z.yx)*rc.y+gtClBUv(Z.xy)*rc.z+gtClBUv(Z.yy)*rc.w,0.,1.),vec4(v4.z));oCl.a=mix(oCl.a,clamp(oCl.a*(rc.x+rc.y+rc.z+rc.w),0.,1.),v4.y);}else oCl="+r("uv")+";":"oCl="+r("uv")+";")+"}else oCl+=1.;oCl.a*=v0.x;if(oCl.a<=0.)discard;"+(i?"if(v0.y>0.)if(v0.y==1.||(v0.y==2.&&oCl.r==oCl.g&&oCl.r==oCl.b))oCl*=v3;else if(v0.y==3.)oCl=v3;else if(v0.y==4.)oCl+=v3;":"")+"}"}},BaseFilter:it,BaseKernelFilter:rt,BaseSamplingFilter:ht,BaseTextureFilter:nt,DisplacementFilter:class extends nt{get GLSL(){return ot}},MaskFilter:ut,PixelateFilter:class extends it{get GLSL(){return"oCl=texture(uTx,floor(v0.zw/vol)*vol);"}},EdgeDetectFilter:class extends rt{constructor(t,e=1){super(t,e),this.kernels=[-1,-1,-1,-1,8,-1,-1,-1,-1]}},SharpenFilter:class extends rt{constructor(t,e=1){super(t,e),this.kernels=[0,-1,0,-1,5,-1,0,-1,0]}},SaturateFilter:class extends rt{get GLSL(){return"oCl.rgb=(oCl.rgb*(1.-vl[1]))+vec3(kr[0].r*oCl.r+kr[0].g*oCl.g+kr[0].b*oCl.b,kr[1].r*oCl.r+kr[1].g*oCl.g+kr[1].b*oCl.b,kr[2].r*oCl.r+kr[2].g*oCl.g+kr[2].b*oCl.b);"}get intensity(){return this.v[0]}set intensity(t){this.v[0]=t;const e=1-t,s=.3*e,i=.59*e,r=.11*e;this.kernels=[s+t,i,r,0,s,i+t,r,0,s,i,r+t,0]}},GrayscaleFilter:class extends it{get GLSL(){return"oCl=oClVl+vec4(vec3(gtGS(oCl.rgb)),oCl.a)*v;"}},SepiaFilter:class extends it{get GLSL(){return"oCl=oClVl+vec4(vec3(.874,.514,.156)*gtGS(oCl.rgb),oCl.a)*v;"}},InvertFilter:class extends it{get GLSL(){return"oCl=oClVl+vec4(1.-oCl.rgb,oCl.a)*v;"}},TintFilter:class extends it{constructor(t,e,s,i){super(t),this.r=e,this.g=s,this.b=i}get GLSL(){return"oCl.rgb*=rgb*v;"}},ColorLimitFilter:class extends it{get GLSL(){return"oCl.rgb=(round((oCl.rgb*255.)/v)/255.)*v;"}},VignetteFilter:class extends it{constructor(t,e,s,i,r,h){super(t),this.roundness=e,this.transition=s,this.r=i,this.g=r,this.b=h}get GLSL(){return"vec2 pv=pow(abs(v0.xy*v),vec2(vl[1]));float cv=clamp((1.-length(pv))*vl[5],0.,1.);oCl.rgb=oCl.rgb*cv+rgb*(1.-cv);"}get roundness(){return this.v[1]}set roundness(t){this.v[1]=t}get transition(){return 1/this.v[5]}set transition(t){this.v[5]=1/t}},RainbowFilter:class extends it{get GLSL(){return"oCl.rgb+=vec3(v0.xy*.15,(v0.x*v0.y)*.15)*v;"}},BrightnessContrastFilter:class extends it{constructor(t,e){super(t),this.contrast=e}get GLSL(){return"oCl.rgb=(vl[1]+1.)*oCl.rgb*v-.5*vl[1];"}get brightness(){return this.v[0]}set brightness(t){this.v[0]=t}get contrast(){return 100*this.v[1]}set contrast(t){this.v[1]=t/100}},GammaFilter:class extends it{get GLSL(){return"oCl.rgb=pow(oCl.rgb,vec3(1./v));"}},BlurFilter:class extends ht{get GLSL(){return lt}},GlowFilter:class extends ht{get GLSL(){return dt}},ChromaticAberrationFilter:class extends it{constructor(t,e=!1,s=.5,i=.5,r=!1){super(t),this.isRadial=e,this.centerX=s,this.centerY=i,this.invertRadial=r}get GLSL(){return"vec4 pcl=vec4(texture(uTx,v0.zw-vec2(vol.x,0)).r,oCl.g,texture(uTx,v0.zw+vec2(vol.x,0)).b,1);float dst=mix(1.,clamp(distance(vec2(vl[3],vl[4]),v0.zw),0.,1.),vl[2]),mA=mix(dst,1.-dst,vl[5]),mB=1.-mA;oCl=mA*pcl+mB*oCl;"}get isRadial(){return this.v[2]}set isRadial(t){this.v[2]=t?1:0}get centerX(){return this.v[3]}set centerX(t){this.v[3]=t}get centerY(){return this.v[4]}set centerY(t){this.v[4]=t}get invertRadial(){return this.v[5]}set invertRadial(t){this.v[5]=t}}},console.log(`%cPWGL v${AGL.version}\nhttps://github.com/asjs-dev/pwgl`,"background:#222;color:#0F0");
